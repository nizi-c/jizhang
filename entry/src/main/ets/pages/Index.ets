import { AccountRecord } from '../models/AccountRecord';
import { AccountBook } from '../models/AccountBook';
import { AccountViewModel } from '../viewmodel/AccountViewModel';
import { StorageUtil } from '../utils/StorageUtil';
import { DateUtil } from '../utils/DateUtil';
import { COLORS, DynamicColors, ColorScheme } from '../constants/Constants';
import { LIGHT_COLOR_SCHEME, DARK_COLOR_SCHEME } from '../constants/ColorSchemes';
import { ThemeUtil, ThemeType, ThemeColors } from '../utils/ThemeUtil';
import { MockData } from '../utils/MockData';
import { AccountBookUtil } from '../utils/AccountBookUtil';
import { ResponsiveUtil, DeviceType } from '../utils/ResponsiveUtil';
import { ResponsiveConstants } from '../constants/ResponsiveConstants';
import { EventBus, Events } from '../utils/EventBus';
import router from '@ohos.router';
import { QueryPage } from './QueryPage';
import { ChartPage } from './ChartPage';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';

interface StatsResult {
  income: number;
  expense: number;
}

@Entry
@Component
struct Index {
  @State todayIncome: number = 0;
  @State todayExpense: number = 0;
  @State monthIncome: number = 0;
  @State monthExpense: number = 0;
  @State records: AccountRecord[] = [];
  @State viewModel: AccountViewModel = new AccountViewModel();
  @State currentTheme: ThemeType = 'light';
  @State colors: ThemeColors = ThemeUtil.LIGHT_THEME;
  @State currentBookName: string = 'é»˜è®¤è´¦æœ¬';
  @State deviceType: DeviceType = ResponsiveUtil.getDeviceType();
  @State screenWidth: number = ResponsiveUtil.getScreenWidth();
  @State refreshTrigger: number = 0;  // å¼ºåˆ¶åˆ·æ–°æ ‡è®°
  menuDialogController: CustomDialogController | undefined = undefined;

  aboutToAppear() {
    const context = getContext(this);
    StorageUtil.setContext(context);
    
    // åˆå§‹åŒ–è´¦æœ¬ç®¡ç†
    AccountBookUtil.init(context as common.UIAbilityContext).then(() => {
      console.log('Index: è´¦æœ¬ç®¡ç†å·²åˆå§‹åŒ–');
      this.loadRecords();
      this.loadCurrentBook();
    });
    
    ThemeUtil.initTheme().then(() => {
      this.currentTheme = ThemeUtil.getTheme();
      this.colors = ThemeUtil.getColors();
    });

    // ç›‘å¬è®°å½•æ›´æ–°äº‹ä»¶ - ä½¿ç”¨ç®­å¤´å‡½æ•°ä¿æŒ this ä¸Šä¸‹æ–‡
    EventBus.on(Events.RECORDS_CHANGED, () => {
      console.log('Index: æ”¶åˆ° RECORDS_CHANGED äº‹ä»¶ï¼Œé‡æ–°åŠ è½½æ•°æ®');
      this.loadRecords();
    });

    // ç›‘å¬è´¦æœ¬æ›´æ–°äº‹ä»¶
    EventBus.on(Events.BOOK_UPDATED, () => {
      console.log('Index: æ”¶åˆ° BOOK_UPDATED äº‹ä»¶ï¼Œé‡æ–°åŠ è½½è´¦æœ¬ä¿¡æ¯');
      this.loadCurrentBook();
    });

    // ç›‘å¬è´¦æœ¬åˆ‡æ¢äº‹ä»¶
    EventBus.on(Events.BOOK_SWITCHED, () => {
      console.log('Index: æ”¶åˆ° BOOK_SWITCHED äº‹ä»¶ï¼Œé‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®');
      this.loadRecords();
      this.loadCurrentBook();
    });
  }

  onPageShow() {
    // æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶éƒ½é‡æ–°åŠ è½½æ•°æ®ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
    console.log('Index: onPageShow è§¦å‘ï¼Œé‡æ–°åŠ è½½æ•°æ®');
    this.loadRecords();
    this.loadCurrentBook();
  }

  onPageHide() {
    // é¡µé¢éšè—æ—¶çš„å¤„ç†
  }

  onWindowFocusChanged(hasFocus: boolean) {
    // å½“çª—å£èŽ·å¾—ç„¦ç‚¹æ—¶åˆ·æ–°æ•°æ®
    if (hasFocus) {
      console.log('Index: onWindowFocusChanged èŽ·å¾—ç„¦ç‚¹ï¼Œé‡æ–°åŠ è½½æ•°æ®');
      this.loadRecords();
      this.loadCurrentBook();
    }
  }

  onBackPress() {
    // è¿”å›žæ—¶åˆ·æ–°æ•°æ®
    console.log('Index: onBackPress è§¦å‘');
    this.loadRecords();
    this.loadCurrentBook();
    return false;
  }

  loadRecords() {
    StorageUtil.getRecords().then((newRecords: AccountRecord[]) => {
      console.log('Index: ä»Žå­˜å‚¨è¯»å–çš„è®°å½•æ•°:', newRecords.length);
      
      // å¼ºåˆ¶æ›´æ–°æ•°ç»„å¼•ç”¨ï¼Œè§¦å‘ UI åˆ·æ–°
      this.records = [...newRecords];
      
      // ç¡®ä¿ ViewModel çš„ records è¢«æ­£ç¡®æ›´æ–°
      this.viewModel.records = [...newRecords];
      
      console.log('Index: æ›´æ–°åŽ - this.records é•¿åº¦:', this.records.length, 'viewModel.records é•¿åº¦:', this.viewModel.records.length);
      
      this.updateSummary();
      console.log('Index: æ•°æ®å·²åŠ è½½ï¼Œè®°å½•æ•°:', this.records.length, 'ä»Šæ—¥æ”¶å…¥:', this.todayIncome, 'æ”¯å‡º:', this.todayExpense);
    }).catch((error: Error) => {
      console.error('Index: åŠ è½½è®°å½•å¤±è´¥:', error);
    });
  }

  loadCurrentBook() {
    AccountBookUtil.getCurrentBook().then((book: AccountBook | null) => {
      if (book) {
        this.currentBookName = book.name;
        console.log('Index: å½“å‰è´¦æœ¬:', book.name);
      }
    }).catch((error: Error) => {
      console.error('Index: åŠ è½½è´¦æœ¬å¤±è´¥:', error);
    });
  }

  updateSummary() {
    console.log('Index: updateSummary è¢«è°ƒç”¨ï¼ŒViewModel ä¸­çš„è®°å½•æ•°:', this.viewModel.records.length);
    
    const today = this.viewModel.getTodaySummary();
    console.log('Index: ä»Šæ—¥ç»Ÿè®¡ - æ”¶å…¥:', today.income, 'æ”¯å‡º:', today.expense);
    
    this.todayIncome = today.income;
    this.todayExpense = today.expense;

    const month = this.viewModel.getMonthSummary();
    console.log('Index: æœ¬æœˆç»Ÿè®¡ - æ”¶å…¥:', month.income, 'æ”¯å‡º:', month.expense);
    
    this.monthIncome = month.income;
    this.monthExpense = month.expense;
    
    // å¼ºåˆ¶åˆ·æ–° UI
    this.refreshTrigger = this.refreshTrigger + 1;
    
    console.log('Index: ç»Ÿè®¡æ•°æ®å·²æ›´æ–° - ä»Šæ—¥æ”¶å…¥:', this.todayIncome, 'æ”¯å‡º:', this.todayExpense, 'æœ¬æœˆæ”¶å…¥:', this.monthIncome, 'æ”¯å‡º:', this.monthExpense, 'åˆ·æ–°æ ‡è®°:', this.refreshTrigger);
  }

  getColorScheme() {
    return this.currentTheme === 'light' ? LIGHT_COLOR_SCHEME : DARK_COLOR_SCHEME;
  }

  updateDeviceInfo() {
    this.deviceType = ResponsiveUtil.getDeviceType();
    this.screenWidth = ResponsiveUtil.getScreenWidth();
  }

  openMenuDialog() {
    let self = this;
    this.menuDialogController = new CustomDialogController({
      builder: () => {
        self.buildMenuDialog();
      },
      autoCancel: true,
      alignment: DialogAlignment.Center,
      customStyle: true
    });
    this.menuDialogController?.open();
  }

  @Builder
  buildMenuDialog() {
    Column() {
      Button() {
        Row() {
          Image($r('app.media.zhangben'))
            .width(ResponsiveConstants.getFontSize('body'))
            .height(ResponsiveConstants.getFontSize('body'))
            .margin({ right: ResponsiveConstants.getSpacing('small') })
          Text('è´¦æœ¬ç®¡ç†')
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .fontColor(this.colors.primary)
            .fontWeight(FontWeight.Bold)
        }
      }
      .width('100%')
      .height(ResponsiveConstants.getButtonHeight('medium'))
      .backgroundColor(this.colors.cardBg)
      .onClick(() => {
        this.menuDialogController?.close();
        router.pushUrl({ url: 'pages/AccountBooksPage' });
      })

      Divider()
        .strokeWidth(1)
        .color(this.colors.border)

      Button() {
        Row() {
          Image($r('app.media.tianjia'))
            .width(ResponsiveConstants.getFontSize('body'))
            .height(ResponsiveConstants.getFontSize('body'))
            .margin({ right: ResponsiveConstants.getSpacing('small') })
          Text('æ·»åŠ è´¦å•')
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .fontColor(this.colors.textPrimary)
        }
      }
      .width('100%')
      .height(ResponsiveConstants.getButtonHeight('medium'))
      .backgroundColor(this.colors.cardBg)
      .onClick(() => {
        this.menuDialogController?.close();
        router.pushUrl({ url: 'pages/AddRecordPage' });
      })

      Divider()
        .strokeWidth(1)
        .color(this.colors.border)

      Button() {
        Row() {
          Image($r('app.media.liushui'))
            .width(ResponsiveConstants.getFontSize('body'))
            .height(ResponsiveConstants.getFontSize('body'))
            .margin({ right: ResponsiveConstants.getSpacing('small') })
          Text('æµæ°´')
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .fontColor(this.colors.textPrimary)
        }
      }
      .width('100%')
      .height(ResponsiveConstants.getButtonHeight('medium'))
      .backgroundColor(this.colors.cardBg)
      .onClick(() => {
        this.menuDialogController?.close();
        router.pushUrl({ url: 'pages/RecordsPage' });
      })

      Divider()
        .strokeWidth(1)
        .color(this.colors.border)

      Button() {
        Row() {
          Image($r('app.media.tongji'))
            .width(ResponsiveConstants.getFontSize('body'))
            .height(ResponsiveConstants.getFontSize('body'))
            .margin({ right: ResponsiveConstants.getSpacing('small') })
          Text('ç»Ÿè®¡')
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .fontColor(this.colors.textPrimary)
        }
      }
      .width('100%')
      .height(ResponsiveConstants.getButtonHeight('medium'))
      .backgroundColor(this.colors.cardBg)
      .onClick(() => {
        this.menuDialogController?.close();
        router.pushUrl({ url: 'pages/ChartPageEntry' });
      })

      Divider()
        .strokeWidth(1)
        .color(this.colors.border)

      Button() {
        Row() {
          Text('ðŸ’°')
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .margin({ right: ResponsiveConstants.getSpacing('small') })
          Text('é¢„ç®—ç®¡ç†')
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .fontColor(this.colors.textPrimary)
        }
      }
      .width('100%')
      .height(ResponsiveConstants.getButtonHeight('medium'))
      .backgroundColor(this.colors.cardBg)
      .onClick(() => {
        this.menuDialogController?.close();
        router.pushUrl({ url: 'pages/BudgetPage' });
      })

      Divider()
        .strokeWidth(1)
        .color(this.colors.border)

      Button() {
        Row() {
          Image(this.currentTheme === 'light' ? $r('app.media.moon') : $r('app.media.sun'))
            .width(ResponsiveConstants.getFontSize('body'))
            .height(ResponsiveConstants.getFontSize('body'))
            .margin({ right: ResponsiveConstants.getSpacing('small') })
          Text(this.currentTheme === 'light' ? 'æ·±è‰²æ¨¡å¼' : 'æµ…è‰²æ¨¡å¼')
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .fontColor(this.colors.textPrimary)
        }
      }
      .width('100%')
      .height(ResponsiveConstants.getButtonHeight('medium'))
      .backgroundColor(this.colors.cardBg)
      .onClick(() => {
        this.currentTheme = ThemeUtil.toggleTheme();
        this.colors = ThemeUtil.getColors();
        this.menuDialogController?.close();
      })

      Divider()
        .strokeWidth(1)
        .color(this.colors.border)

      Button() {
        Row() {
          Text('ðŸ“Š')
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .margin({ right: ResponsiveConstants.getSpacing('small') })
          Text('ç”Ÿæˆæµ‹è¯•æ•°æ®')
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .fontColor(this.colors.textPrimary)
        }
      }
      .width('100%')
      .height(ResponsiveConstants.getButtonHeight('medium'))
      .backgroundColor(this.colors.cardBg)
      .onClick(async () => {
        this.menuDialogController?.close();
        try {
          await MockData.generateMockData();
          promptAction.showToast({
            message: 'å·²ç”Ÿæˆ30å¤©æµ‹è¯•æ•°æ®',
            duration: 2000
          });
          this.loadRecords();
        } catch (error) {
          promptAction.showToast({
            message: 'ç”Ÿæˆæ•°æ®å¤±è´¥',
            duration: 2000
          });
        }
      })
    }
    .width(ResponsiveUtil.isPhone() ? '85%' : '70%')
    .backgroundColor(this.colors.cardBg)
    .borderRadius(ResponsiveConstants.getBorderRadius('large'))
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Column() {
          Text('è®°è´¦æœ¬')
            .fontSize(ResponsiveConstants.getFontSize('title'))
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getColorScheme().NAVBAR.titleColor)
          Text(this.currentBookName)
            .fontSize(ResponsiveConstants.getFontSize('caption'))
            .fontColor(this.getColorScheme().LIST_ITEM.descriptionColor)
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        
        Row()
          .layoutWeight(1)
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('â‹®')
            .fontSize(ResponsiveConstants.getFontSize('title'))
            .fontColor(this.getColorScheme().NAVBAR.titleColor)
        }
        .width(ResponsiveConstants.getButtonHeight('medium'))
        .height(ResponsiveConstants.getButtonHeight('medium'))
        .backgroundColor(this.getColorScheme().NAVBAR.backgroundColor)
        .onClick(() => {
          this.openMenuDialog();
        })
      }
      .width('100%')
      .padding({
        left: ResponsiveConstants.getPadding('medium'),
        right: ResponsiveConstants.getPadding('medium'),
        top: 8,
        bottom: 8
      })
      .backgroundColor(this.getColorScheme().NAVBAR.backgroundColor)
      .border({ width: { bottom: 1 }, color: this.getColorScheme().NAVBAR.borderColor })

      // é¦–é¡µå†…å®¹
      this.buildHomeTab()
    }
    .width('100%')
    .height('100%')
    .backgroundImage(ThemeUtil.getBackgroundImage(this.currentTheme))
    .backgroundImageSize(ImageSize.Cover)
    .backgroundImagePosition(Alignment.Center)
    .key(`main_page_${this.records.length}_${this.refreshTrigger}`)
  }



  @Builder
  buildHomeTab() {
    // æ ¹æ®è®¾å¤‡ç±»åž‹é€‰æ‹©ä¸åŒçš„å¸ƒå±€
    if (ResponsiveUtil.isPhone()) {
      this.buildPhoneLayout();
    } else if (ResponsiveUtil.isTablet()) {
      this.buildTabletLayout();
    } else {
      this.buildLargeLayout();
    }
  }

  @Builder
  buildPhoneLayout() {
    // æ‰‹æœºå¸ƒå±€ï¼šå•åˆ—
    Column() {
      // è°ƒè¯•æŒ‰é’® - æ‰‹åŠ¨åˆ·æ–°
      Button('æ‰‹åŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®')
        .width('90%')
        .margin({ top: 10, bottom: 10 })
        .onClick(() => {
          console.log('æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®è¢«ç‚¹å‡»');
          this.refreshTrigger = this.refreshTrigger + 1;
          console.log('refreshTrigger å·²æ›´æ–°ä¸º:', this.refreshTrigger);
        })
      
      // ä»Šæ—¥ç»Ÿè®¡å¡ç‰‡ - ç›´æŽ¥è®¡ç®—è€Œä¸ä½¿ç”¨ @State å˜é‡
      this.buildStatCardDirect('ä»Šæ—¥æ”¶æ”¯', true);
      
      // æœ¬æœˆç»Ÿè®¡å¡ç‰‡ - ç›´æŽ¥è®¡ç®—è€Œä¸ä½¿ç”¨ @State å˜é‡
      this.buildStatCardDirect('æœ¬æœˆæ”¶æ”¯', false);
      
      // æœ€è¿‘è®°å½•
      this.buildRecentRecords();
    }
    .width('100%')
    .padding({ bottom: ResponsiveConstants.getSpacing('large') })
  }

  @Builder
  buildTabletLayout() {
    // å¹³æ¿å¸ƒå±€ï¼šä¸¤åˆ—
    Column() {
      Row() {
        Column() {
          this.buildStatCardDirect('ä»Šæ—¥æ”¶æ”¯', true);
        }
        .layoutWeight(1)
        .margin({ right: ResponsiveConstants.getSpacing('medium') })

        Column() {
          this.buildStatCardDirect('æœ¬æœˆæ”¶æ”¯', false);
        }
        .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: ResponsiveConstants.getSpacing('large') })

      // æœ€è¿‘è®°å½•
      this.buildRecentRecords();
    }
    .width('100%')
    .padding({ bottom: ResponsiveConstants.getSpacing('large') })
  }

  @Builder
  buildLargeLayout() {
    // å¤§å±å¸ƒå±€ï¼šä¸‰åˆ—æˆ–è‡ªé€‚åº”
    Column() {
      Row() {
        Column() {
          this.buildStatCardDirect('ä»Šæ—¥æ”¶æ”¯', true);
        }
        .layoutWeight(1)
        .margin({ right: ResponsiveConstants.getSpacing('large') })

        Column() {
          this.buildStatCardDirect('æœ¬æœˆæ”¶æ”¯', false);
        }
        .layoutWeight(1)
        .margin({ right: ResponsiveConstants.getSpacing('large') })

        Column() {
          this.buildRecentRecords();
        }
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .padding({ bottom: ResponsiveConstants.getSpacing('large') })
  }

  // è®¡ç®—ä»Šæ—¥ç»Ÿè®¡
  calculateTodayStats(): StatsResult {
    const today = DateUtil.getTodayStr();
    let income: number = 0;
    let expense: number = 0;
    
    this.records.forEach((record: AccountRecord) => {
      if (record.dateStr === today) {
        if (record.type === 'income') {
          income += record.amount;
        } else {
          expense += record.amount;
        }
      }
    });
    
    const result: StatsResult = { income: income, expense: expense };
    return result;
  }

  // è®¡ç®—æœ¬æœˆç»Ÿè®¡
  calculateMonthStats(): StatsResult {
    const thisMonth = DateUtil.getThisMonthStr();
    let income: number = 0;
    let expense: number = 0;
    
    this.records.forEach((record: AccountRecord) => {
      if (record.dateStr.startsWith(thisMonth)) {
        if (record.type === 'income') {
          income += record.amount;
        } else {
          expense += record.amount;
        }
      }
    });
    
    const result: StatsResult = { income: income, expense: expense };
    return result;
  }

  // ç›´æŽ¥è®¡ç®—ç»Ÿè®¡æ•°æ®çš„æ–¹æ³•
  @Builder
  buildStatCardDirect(title: string, isToday: boolean) {
    if (isToday) {
      this.buildStatCard(title, this.calculateTodayStats().income, this.calculateTodayStats().expense);
    } else {
      this.buildStatCard(title, this.calculateMonthStats().income, this.calculateMonthStats().expense);
    }
  }

  @Builder
  buildStatCard(title: string, income: number, expense: number) {
    Column() {
      Text(title)
        .fontSize(ResponsiveConstants.getFontSize('subtitle'))
        .fontColor(this.getColorScheme().STAT_CARD.titleColor)
        .margin({ bottom: ResponsiveConstants.getSpacing('medium') })

      Row() {
        Column() {
          Text('æ”¶å…¥')
            .fontSize(ResponsiveConstants.getFontSize('caption'))
            .fontColor(this.getColorScheme().STAT_CARD.labelColor)
            .margin({ bottom: 4 })
          Text(`Â¥${income.toFixed(2)}`)
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getColorScheme().STAT_CARD.incomeColor)
            .key(`income_${this.refreshTrigger}`)
        }
        .layoutWeight(1)

        Column() {
          Text('æ”¯å‡º')
            .fontSize(ResponsiveConstants.getFontSize('caption'))
            .fontColor(this.getColorScheme().STAT_CARD.labelColor)
            .margin({ bottom: 4 })
          Text(`Â¥${expense.toFixed(2)}`)
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getColorScheme().STAT_CARD.expenseColor)
            .key(`expense_${this.refreshTrigger}`)
        }
        .layoutWeight(1)

        Column() {
          Text('ç»“ä½™')
            .fontSize(ResponsiveConstants.getFontSize('caption'))
            .fontColor(this.getColorScheme().STAT_CARD.labelColor)
            .margin({ bottom: 4 })
          Text(`Â¥${(income - expense).toFixed(2)}`)
            .fontSize(ResponsiveConstants.getFontSize('body'))
            .fontWeight(FontWeight.Bold)
            .fontColor(income >= expense ? 
              this.getColorScheme().STAT_CARD.incomeColor : 
              this.getColorScheme().STAT_CARD.expenseColor)
            .key(`balance_${this.refreshTrigger}`)
        }
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .padding(ResponsiveConstants.getPadding('medium'))
    .backgroundColor(this.getColorScheme().STAT_CARD.backgroundColor)
    .borderRadius(ResponsiveConstants.getBorderRadius('large'))
    .margin({
      left: ResponsiveConstants.getPadding('medium'),
      right: ResponsiveConstants.getPadding('medium'),
      bottom: ResponsiveConstants.getSpacing('medium')
    })
    .shadow(ResponsiveConstants.getShadow('medium'))
  }

  @Builder
  buildRecentRecords() {
    Column() {
      Text('æœ€è¿‘è®°å½•')
        .fontSize(ResponsiveConstants.getFontSize('subtitle'))
        .fontColor(this.getColorScheme().RECENT_LIST.categoryColor)
        .margin({ bottom: ResponsiveConstants.getSpacing('medium') })

      if (this.records.length === 0) {
        Text('æš‚æ— è®°å½•')
          .fontSize(ResponsiveConstants.getFontSize('body'))
          .fontColor(this.getColorScheme().RECENT_LIST.descriptionColor)
          .width('100%')
          .textAlign(TextAlign.Center)
          .padding(ResponsiveConstants.getPadding('large'))
      } else {
        List() {
          ForEach(this.records.slice(0, 5), (record: AccountRecord) => {
            ListItem() {
              this.buildRecordItem(record)
            }
          }, (record: AccountRecord) => record.id)
        }
        .width('100%')
        .listDirection(Axis.Vertical)
        .divider({ strokeWidth: 1, color: this.getColorScheme().RECENT_LIST.dividerColor })
      }
    }
    .width('100%')
    .padding(ResponsiveConstants.getPadding('medium'))
    .backgroundColor(this.getColorScheme().RECENT_LIST.backgroundColor)
    .borderRadius(ResponsiveConstants.getBorderRadius('large'))
    .margin({
      left: ResponsiveConstants.getPadding('medium'),
      right: ResponsiveConstants.getPadding('medium')
    })
    .shadow(ResponsiveConstants.getShadow('medium'))
  }



  @Builder
  buildRecordItem(record: AccountRecord) {
    Row() {
      Column() {
        Text(record.category)
          .fontSize(ResponsiveConstants.getFontSize('body'))
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getColorScheme().RECENT_LIST.categoryColor)
        Text(record.description)
          .fontSize(ResponsiveConstants.getFontSize('caption'))
          .fontColor(this.getColorScheme().RECENT_LIST.descriptionColor)
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      Column() {
        Text(`${record.type === 'income' ? '+' : '-'}Â¥${record.amount.toFixed(2)}`)
          .fontSize(ResponsiveConstants.getFontSize('body'))
          .fontWeight(FontWeight.Bold)
          .fontColor(record.type === 'income' ? this.getColorScheme().RECENT_LIST.incomeAmountColor : this.getColorScheme().RECENT_LIST.expenseAmountColor)
        Text(record.dateStr)
          .fontSize(ResponsiveConstants.getFontSize('caption'))
          .fontColor(this.getColorScheme().RECENT_LIST.dateColor)
          .margin({ top: 4 })
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .padding(ResponsiveConstants.getSpacing('medium'))
    .backgroundColor(this.getColorScheme().RECENT_LIST.itemBackground)
  }

  @Builder
  buildRecordItemWithSwipe(record: AccountRecord) {
    Swiper() {
      this.buildRecordItem(record)

      Button('åˆ é™¤')
        .width('100%')
        .height('100%')
        .backgroundColor(COLORS.primary)
        .fontColor('#FFFFFF')
        .onClick(() => {
          this.viewModel.deleteRecord(record.id);
          this.records = this.records.filter(r => r.id !== record.id);
          this.updateSummary();
        })
    }
    .indicator(false)
  }


}
