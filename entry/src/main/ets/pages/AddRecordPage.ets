import { AccountRecord } from '../models/AccountRecord';
import { StorageUtil } from '../utils/StorageUtil';
import { DateUtil } from '../utils/DateUtil';
import { COLORS, DynamicColors, EXPENSE_CATEGORIES, INCOME_CATEGORIES, Category } from '../constants/Constants';
import { LIGHT_COLOR_SCHEME, DARK_COLOR_SCHEME } from '../constants/ColorSchemes';
import { ThemeUtil } from '../utils/ThemeUtil';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct AddRecordPage {
  @State recordType: 'income' | 'expense' = 'expense';
  @State selectedCategory: string = '';
  @State amount: string = '';
  @State description: string = '';
  @State selectedDate: string = DateUtil.getTodayStr();
  @State categories: Category[] = [];
  @State selectedMood: string = 'ğŸ˜Šæ»¡æ„'; // é»˜è®¤æ»¡æ„
  @State customCategoryName: string = '';
  @State showCustomCategoryDialog: boolean = false;

  aboutToAppear() {
    StorageUtil.setContext(getContext(this));
    this.updateCategories();
  }

  updateCategories() {
    this.categories = this.recordType === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
    this.selectedCategory = this.categories[0]?.name || '';
  }

  getColorScheme() {
    return ThemeUtil.getTheme() === 'light' ? LIGHT_COLOR_SCHEME : DARK_COLOR_SCHEME;
  }

  async saveRecord() {
    if (!this.amount || !this.selectedCategory) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥é‡‘é¢å’Œé€‰æ‹©åˆ†ç±»',
        duration: 2000
      });
      return;
    }

    try {
      const record: AccountRecord = {
        id: StorageUtil.generateId(),
        type: this.recordType,
        category: this.selectedCategory,
        amount: parseFloat(this.amount),
        description: this.description,
        date: DateUtil.parseDate(this.selectedDate),
        dateStr: this.selectedDate,
        mood: this.selectedMood
      };

      const records = await StorageUtil.getRecords();
      records.unshift(record);
      await StorageUtil.saveRecords(records);

      promptAction.showToast({
        message: 'ä¿å­˜æˆåŠŸ',
        duration: 1500
      });

      // å»¶è¿Ÿè¿”å›ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
      setTimeout(() => {
        router.back();
      }, 500);
    } catch (error) {
      console.error('ä¿å­˜è®°å½•å¤±è´¥:', error);
      promptAction.showToast({
        message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('â†')
            .fontSize(20)
            .fontColor(this.getColorScheme().NAVBAR.backButtonColor)
        }
        .width(36)
        .height(36)
        .backgroundColor(this.getColorScheme().NAVBAR.backgroundColor)
        .onClick(() => {
          router.back();
        })

        Text('æ·»åŠ è´¦å•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getColorScheme().NAVBAR.titleColor)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Row()
          .width(36)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor(this.getColorScheme().NAVBAR.backgroundColor)
      .border({ width: { bottom: 1 }, color: this.getColorScheme().NAVBAR.borderColor })

      Scroll() {
        Column() {
          // ç±»å‹é€‰æ‹©
          Row() {
            Button('æ”¯å‡º')
              .width('48%')
              .height(44)
              .backgroundColor(this.recordType === 'expense' ? this.getColorScheme().TYPE_SELECTOR.expenseActiveBackground : this.getColorScheme().TYPE_SELECTOR.inactiveBackground)
              .fontColor(this.recordType === 'expense' ? this.getColorScheme().TYPE_SELECTOR.activeTextColor : this.getColorScheme().TYPE_SELECTOR.inactiveTextColor)
              .onClick(() => {
                this.recordType = 'expense';
                this.updateCategories();
              })

            Row()
              .width('4%')

            Button('æ”¶å…¥')
              .width('48%')
              .height(44)
              .backgroundColor(this.recordType === 'income' ? this.getColorScheme().TYPE_SELECTOR.incomeActiveBackground : this.getColorScheme().TYPE_SELECTOR.inactiveBackground)
              .fontColor(this.recordType === 'income' ? this.getColorScheme().TYPE_SELECTOR.activeTextColor : this.getColorScheme().TYPE_SELECTOR.inactiveTextColor)
              .onClick(() => {
                this.recordType = 'income';
                this.updateCategories();
              })
          }
          .width('100%')
          .margin({ bottom: 16 })

          // åˆ†ç±»é€‰æ‹©
          Text('åˆ†ç±»')
            .fontSize(12)
            .fontColor(this.getColorScheme().INPUT_SECTION.labelColor)
            .margin({ bottom: 8 })

          Scroll() {
            Row() {
              ForEach(this.categories, (category: Category) => {
                Column() {
                  Text(category.icon)
                    .fontSize(24)
                    .margin({ bottom: 4 })
                  Text(category.name)
                    .fontSize(10)
                    .fontColor(this.selectedCategory === category.name ? this.getColorScheme().CATEGORY_GRID.activeTextColor : this.getColorScheme().CATEGORY_GRID.textColor)
                }
                .width(60)
                .height(80)
                .padding(8)
                .backgroundColor(this.selectedCategory === category.name ? this.getColorScheme().CATEGORY_GRID.activeBackground : this.getColorScheme().CATEGORY_GRID.itemBackground)
                .borderRadius(8)
                .border({
                  width: this.selectedCategory === category.name ? 2 : 0,
                  color: this.getColorScheme().CATEGORY_GRID.activeBorderColor
                })
                .margin({ right: 8 })
                .onClick(() => {
                  this.selectedCategory = category.name;
                })
              }, (category: Category) => category.name)
              
              // æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»æŒ‰é’®
              Column() {
                Text('â•')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text('è‡ªå®šä¹‰')
                  .fontSize(10)
                  .fontColor(this.getColorScheme().CATEGORY_GRID.textColor)
              }
              .width(60)
              .height(80)
              .padding(8)
              .backgroundColor(this.getColorScheme().CATEGORY_GRID.itemBackground)
              .borderRadius(8)
              .border({
                width: 1,
                color: this.getColorScheme().CATEGORY_GRID.activeBorderColor,
                style: BorderStyle.Dashed
              })
              .onClick(() => {
                this.showCustomCategoryDialog = true;
              })
            }
          }
          .width('100%')
          .height(90)
          .scrollable(ScrollDirection.Horizontal)
          .scrollBar(BarState.Off)
          .margin({ bottom: 16 })

          // é‡‘é¢è¾“å…¥
          Text('é‡‘é¢')
            .fontSize(12)
            .fontColor(this.getColorScheme().INPUT_SECTION.labelColor)
            .margin({ bottom: 8 })

          TextInput({ placeholder: 'è¯·è¾“å…¥é‡‘é¢', text: this.amount })
            .type(InputType.Number)
            .width('100%')
            .height(44)
            .padding({ left: 12, right: 12 })
            .backgroundColor(this.getColorScheme().INPUT_SECTION.inputBackground)
            .borderRadius(8)
            .placeholderColor(this.getColorScheme().INPUT_SECTION.placeholderColor)
            .onChange((value: string) => {
              this.amount = value;
            })
            .margin({ bottom: 16 })

          // ç”¨é€”æè¿°
          Text('ç”¨é€”')
            .fontSize(12)
            .fontColor(this.getColorScheme().INPUT_SECTION.labelColor)
            .margin({ bottom: 8 })

          TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨é€”æè¿°' })
            .width('100%')
            .height(44)
            .padding({ left: 12, right: 12 })
            .backgroundColor(this.getColorScheme().INPUT_SECTION.inputBackground)
            .borderRadius(8)
            .placeholderColor(this.getColorScheme().INPUT_SECTION.placeholderColor)
            .onChange((value: string) => {
              this.description = value;
            })
            .margin({ bottom: 16 })

          // æ—¥æœŸé€‰æ‹©
          Text('æ—¥æœŸ')
            .fontSize(12)
            .fontColor(this.getColorScheme().INPUT_SECTION.labelColor)
            .margin({ bottom: 8 })

          TextInput({ placeholder: 'YYYY-MM-DD', text: this.selectedDate })
            .width('100%')
            .height(44)
            .padding({ left: 12, right: 12 })
            .backgroundColor(this.getColorScheme().INPUT_SECTION.inputBackground)
            .borderRadius(8)
            .placeholderColor(this.getColorScheme().INPUT_SECTION.placeholderColor)
            .onChange((value: string) => {
              this.selectedDate = value;
            })
            .margin({ bottom: 16 })

          // å¿ƒæƒ…é€‰æ‹©
          Text('å¿ƒæƒ…')
            .fontSize(12)
            .fontColor(this.getColorScheme().INPUT_SECTION.labelColor)
            .margin({ bottom: 8 })

          Scroll() {
            Row() {
              Button('ğŸ˜Šæ»¡æ„')
                .height(44)
                .padding({ left: 16, right: 16 })
                .backgroundColor(this.selectedMood === 'ğŸ˜Šæ»¡æ„' ? this.getColorScheme().TYPE_SELECTOR.activeBackground : this.getColorScheme().TYPE_SELECTOR.inactiveBackground)
                .fontColor(this.selectedMood === 'ğŸ˜Šæ»¡æ„' ? this.getColorScheme().TYPE_SELECTOR.activeTextColor : this.getColorScheme().TYPE_SELECTOR.inactiveTextColor)
                .onClick(() => {
                  this.selectedMood = 'ğŸ˜Šæ»¡æ„';
                })
                .margin({ right: 8 })

              Button('ğŸ˜Ÿåæ‚”')
                .height(44)
                .padding({ left: 16, right: 16 })
                .backgroundColor(this.selectedMood === 'ğŸ˜Ÿåæ‚”' ? this.getColorScheme().TYPE_SELECTOR.activeBackground : this.getColorScheme().TYPE_SELECTOR.inactiveBackground)
                .fontColor(this.selectedMood === 'ğŸ˜Ÿåæ‚”' ? this.getColorScheme().TYPE_SELECTOR.activeTextColor : this.getColorScheme().TYPE_SELECTOR.inactiveTextColor)
                .onClick(() => {
                  this.selectedMood = 'ğŸ˜Ÿåæ‚”';
                })
                .margin({ right: 8 })

              Button('ğŸ‰æƒŠå–œ')
                .height(44)
                .padding({ left: 16, right: 16 })
                .backgroundColor(this.selectedMood === 'ğŸ‰æƒŠå–œ' ? this.getColorScheme().TYPE_SELECTOR.activeBackground : this.getColorScheme().TYPE_SELECTOR.inactiveBackground)
                .fontColor(this.selectedMood === 'ğŸ‰æƒŠå–œ' ? this.getColorScheme().TYPE_SELECTOR.activeTextColor : this.getColorScheme().TYPE_SELECTOR.inactiveTextColor)
                .onClick(() => {
                  this.selectedMood = 'ğŸ‰æƒŠå–œ';
                })
            }
          }
          .width('100%')
          .scrollable(ScrollDirection.Horizontal)
          .scrollBar(BarState.Off)
          .margin({ bottom: 24 })

          // æŒ‰é’®
          Row() {
            Button('å–æ¶ˆ')
              .width('48%')
              .height(44)
              .backgroundColor(this.getColorScheme().BUTTON_SECTION.cancelBackground)
              .fontColor(this.getColorScheme().BUTTON_SECTION.cancelTextColor)
              .onClick(() => {
                router.back();
              })

            Row()
              .width('4%')

            Button('ä¿å­˜')
              .width('48%')
              .height(44)
              .backgroundColor(this.getColorScheme().BUTTON_SECTION.saveBackground)
              .fontColor(this.getColorScheme().BUTTON_SECTION.saveTextColor)
              .onClick(() => {
                this.saveRecord();
              })
          }
          .width('100%')
        }
        .width('100%')
        .padding(16)
      }
        .width('100%')
        .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(COLORS.background)
      
      // è‡ªå®šä¹‰åˆ†ç±»å¯¹è¯æ¡†
      if (this.showCustomCategoryDialog) {
        Column() {
          Text('æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getColorScheme().DIALOG.titleColor)
            .margin({ bottom: 16 })

          TextInput({ placeholder: 'è¯·è¾“å…¥åˆ†ç±»åç§°', text: this.customCategoryName })
            .width('100%')
            .height(44)
            .backgroundColor(this.getColorScheme().INPUT_SECTION.inputBackground)
            .borderRadius(8)
            .onChange((value: string) => {
              this.customCategoryName = value;
            })
            .margin({ bottom: 16 })

          Row() {
            Button('å–æ¶ˆ')
              .width('48%')
              .height(40)
              .backgroundColor(this.getColorScheme().BUTTON_SECTION.cancelBackground)
              .fontColor(this.getColorScheme().BUTTON_SECTION.cancelTextColor)
              .onClick(() => {
                this.showCustomCategoryDialog = false;
                this.customCategoryName = '';
              })

            Row().width('4%')

            Button('ç¡®å®š')
              .width('48%')
              .height(40)
              .backgroundColor(this.getColorScheme().BUTTON_SECTION.saveBackground)
              .fontColor(this.getColorScheme().BUTTON_SECTION.saveTextColor)
              .onClick(() => {
                if (this.customCategoryName) {
                  // æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»åˆ°å½“å‰åˆ†ç±»åˆ—è¡¨
                  const newCategory: Category = {
                    name: this.customCategoryName,
                    icon: 'ğŸ“Œ',
                    color: '#B8B5B2'
                  };
                  this.categories.push(newCategory);
                  this.selectedCategory = this.customCategoryName;
                  this.showCustomCategoryDialog = false;
                  this.customCategoryName = '';
                }
              })
          }
          .width('100%')
        }
        .width('80%')
        .padding(20)
        .backgroundColor(this.getColorScheme().DIALOG.backgroundColor)
        .borderRadius(12)
        .shadow({ radius: 20, color: '#00000040' })
      }
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
  }
}
