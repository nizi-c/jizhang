import { AccountRecord } from '../models/AccountRecord';
import { StorageUtil } from '../utils/StorageUtil';
import { DateUtil } from '../utils/DateUtil';
import { COLORS, DynamicColors, EXPENSE_CATEGORIES, INCOME_CATEGORIES, Category } from '../constants/Constants';
import { LIGHT_COLOR_SCHEME, DARK_COLOR_SCHEME } from '../constants/ColorSchemes';
import { ThemeUtil } from '../utils/ThemeUtil';
import { BudgetUtil } from '../utils/BudgetUtil';
import { Budget } from '../models/Budget';
import { CategoryUtil } from '../utils/CategoryUtil';
import { ResponsiveUtil } from '../utils/ResponsiveUtil';
import { ResponsiveConstants } from '../constants/ResponsiveConstants';
import { EventBus, Events } from '../utils/EventBus';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';

@Entry
@Component
struct AddRecordPage {
  @State recordType: 'income' | 'expense' = 'expense';
  @State selectedCategory: string = '';
  @State amount: string = '';
  @State description: string = '';
  @State selectedDate: string = DateUtil.getTodayStr();
  @State categories: Category[] = [];
  @State selectedMood: string = 'ðŸ˜Šæ»¡æ„'; // é»˜è®¤æ»¡æ„
  @State customCategoryName: string = '';
  @State showCustomCategoryDialog: boolean = false;

  aboutToAppear() {
    const context = getContext(this) as common.UIAbilityContext;
    console.log('AddRecordPage: aboutToAppear è¢«è°ƒç”¨');
    
    StorageUtil.setContext(context);
    console.log('AddRecordPage: StorageUtil Context å·²è®¾ç½®');
    
    BudgetUtil.init(context).then(() => {
      console.log('AddRecordPage: BudgetUtil å·²åˆå§‹åŒ–');
      this.updateCategories();
    }).catch((error: Error) => {
      console.error('AddRecordPage: BudgetUtil åˆå§‹åŒ–å¤±è´¥:', error);
      this.updateCategories();
    });
  }

  updateCategories() {
    const baseCategories = this.recordType === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
    
    CategoryUtil.getCustomCategories().then((customCategories: Category[]) => {
      // åˆå¹¶åŸºç¡€åˆ†ç±»å’Œè‡ªå®šä¹‰åˆ†ç±»ï¼ˆåªæ˜¾ç¤ºæ”¯å‡ºç±»åž‹çš„è‡ªå®šä¹‰åˆ†ç±»ï¼‰
      const expenseCustom = customCategories.filter(c => this.recordType === 'expense');
      this.categories = [...baseCategories, ...expenseCustom];
      
      if (!this.selectedCategory || !this.categories.find(c => c.name === this.selectedCategory)) {
        this.selectedCategory = this.categories[0]?.name || '';
      }
      console.log('AddRecordPage: åˆ†ç±»å·²åŠ è½½ï¼Œæ€»æ•°:', this.categories.length);
    }).catch((error: Error) => {
      console.error('AddRecordPage: åŠ è½½åˆ†ç±»å¤±è´¥:', error);
      this.categories = baseCategories;
      this.selectedCategory = this.categories[0]?.name || '';
    });
  }

  getColorScheme() {
    return ThemeUtil.getTheme() === 'light' ? LIGHT_COLOR_SCHEME : DARK_COLOR_SCHEME;
  }

  async saveRecord() {
    if (!this.amount || !this.selectedCategory) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥é‡‘é¢å’Œé€‰æ‹©åˆ†ç±»',
        duration: 2000
      });
      return;
    }

    try {
      const record: AccountRecord = {
        id: StorageUtil.generateId(),
        type: this.recordType,
        category: this.selectedCategory,
        amount: parseFloat(this.amount),
        description: this.description,
        date: DateUtil.parseDate(this.selectedDate),
        dateStr: this.selectedDate,
        mood: this.selectedMood
      };

      const records = await StorageUtil.getRecords();
      records.unshift(record);
      await StorageUtil.saveRecords(records);
      console.log('AddRecordPage: è®°å½•å·²ä¿å­˜ï¼Œæ€»æ•°:', records.length);

      // å¦‚æžœæ˜¯æ”¯å‡ºï¼Œæ£€æŸ¥é¢„ç®—çŠ¶æ€
      if (this.recordType === 'expense') {
        await this.checkBudgetWarning(record);
      }

      promptAction.showToast({
        message: 'ä¿å­˜æˆåŠŸ',
        duration: 1500
      });

      // å‘é€äº‹ä»¶é€šçŸ¥å…¶ä»–é¡µé¢æ•°æ®å·²æ›´æ–°
      console.log('AddRecordPage: å‘é€ RECORDS_CHANGED äº‹ä»¶');
      EventBus.emit(Events.RECORDS_CHANGED, record);

      // ä½¿ç”¨ replaceUrl å¼ºåˆ¶é‡å»ºé¡µé¢ï¼Œè§£å†³ ArkTS çŠ¶æ€ç®¡ç† bug
      setTimeout(() => {
        console.log('AddRecordPage: å¼ºåˆ¶é‡å»ºé¦–é¡µ');
        router.replaceUrl({
          url: 'pages/Index',
          params: { refresh: Date.now() }
        });
      }, 1200);
    } catch (error) {
      console.error('ä¿å­˜è®°å½•å¤±è´¥:', error);
      promptAction.showToast({
        message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  async checkBudgetWarning(record: AccountRecord) {
    try {
      const budgets = await BudgetUtil.getAllBudgets();
      const categoryBudget = budgets.find(b => b.category === record.category);
      
      if (!categoryBudget) {
        return;
      }

      // è®¡ç®—è¯¥åˆ†ç±»çš„æ€»æ”¯å‡º
      const records = await StorageUtil.getRecords();
      const totalUsed = records
        .filter(r => r.category === record.category && r.type === 'expense')
        .reduce((sum, r) => sum + r.amount, 0);

      const percentage = (totalUsed / categoryBudget.amount) * 100;

      // è¶…æ”¯é¢„è­¦
      if (percentage > 100) {
        const exceeded = totalUsed - categoryBudget.amount;
        AlertDialog.show({
          title: 'ðŸ• é¢„ç®—è¶…æ”¯æé†’',
          message: `ã€${record.category}ã€‘é¢„ç®—å·²è¶…æ”¯ï¼\n\né¢„ç®—é‡‘é¢ï¼šÂ¥${categoryBudget.amount.toFixed(2)}\nå·²ä½¿ç”¨ï¼šÂ¥${totalUsed.toFixed(2)}\nè¶…æ”¯ï¼šÂ¥${exceeded.toFixed(2)}`,
          confirm: {
            value: 'çŸ¥é“äº†',
            action: () => {}
          }
        });
      }
      // å³å°†è¶…æ”¯é¢„è­¦ï¼ˆè¾¾åˆ°90%ï¼‰
      else if (percentage >= categoryBudget.warningThreshold) {
        const remaining = categoryBudget.amount - totalUsed;
        AlertDialog.show({
          title: 'ðŸ• é¢„ç®—é¢„è­¦',
          message: `ã€${record.category}ã€‘é¢„ç®—å³å°†è¶…æ”¯ï¼\n\né¢„ç®—é‡‘é¢ï¼šÂ¥${categoryBudget.amount.toFixed(2)}\nå·²ä½¿ç”¨ï¼šÂ¥${totalUsed.toFixed(2)}ï¼ˆ${percentage.toFixed(1)}%ï¼‰\nå‰©ä½™ï¼šÂ¥${remaining.toFixed(2)}`,
          confirm: {
            value: 'çŸ¥é“äº†',
            action: () => {}
          }
        });
      }
    } catch (error) {
      console.error('æ£€æŸ¥é¢„ç®—å¤±è´¥:', error);
    }
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('â†')
            .fontSize(20)
            .fontColor(this.getColorScheme().NAVBAR.backButtonColor)
        }
        .width(36)
        .height(36)
        .backgroundColor(this.getColorScheme().NAVBAR.backgroundColor)
        .onClick(() => {
          router.back();
        })

        Text('æ·»åŠ è´¦å•')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getColorScheme().NAVBAR.titleColor)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Row()
          .width(36)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor(this.getColorScheme().NAVBAR.backgroundColor)
      .border({ width: { bottom: 1 }, color: this.getColorScheme().NAVBAR.borderColor })

      Scroll() {
        Column() {
          // ç±»åž‹é€‰æ‹©
          Row() {
            Button('æ”¯å‡º')
              .width('48%')
              .height(44)
              .backgroundColor(this.recordType === 'expense' ? this.getColorScheme().TYPE_SELECTOR.expenseActiveBackground : this.getColorScheme().TYPE_SELECTOR.inactiveBackground)
              .fontColor(this.recordType === 'expense' ? this.getColorScheme().TYPE_SELECTOR.activeTextColor : this.getColorScheme().TYPE_SELECTOR.inactiveTextColor)
              .onClick(() => {
                this.recordType = 'expense';
                this.updateCategories();
              })

            Row()
              .width('4%')

            Button('æ”¶å…¥')
              .width('48%')
              .height(44)
              .backgroundColor(this.recordType === 'income' ? this.getColorScheme().TYPE_SELECTOR.incomeActiveBackground : this.getColorScheme().TYPE_SELECTOR.inactiveBackground)
              .fontColor(this.recordType === 'income' ? this.getColorScheme().TYPE_SELECTOR.activeTextColor : this.getColorScheme().TYPE_SELECTOR.inactiveTextColor)
              .onClick(() => {
                this.recordType = 'income';
                this.updateCategories();
              })
          }
          .width('100%')
          .margin({ bottom: 16 })

          // åˆ†ç±»é€‰æ‹©
          Text('åˆ†ç±»')
            .fontSize(12)
            .fontColor(this.getColorScheme().INPUT_SECTION.labelColor)
            .margin({ bottom: 8 })

          // åˆ†ç±»è¾“å…¥æ¡†
          TextInput({ placeholder: 'è¾“å…¥åˆ†ç±»åç§°', text: this.selectedCategory })
            .width('100%')
            .height(44)
            .padding({ left: 12, right: 12 })
            .backgroundColor(this.getColorScheme().INPUT_SECTION.inputBackground)
            .borderRadius(8)
            .placeholderColor(this.getColorScheme().INPUT_SECTION.placeholderColor)
            .onChange((value: string) => {
              this.selectedCategory = value;
            })
            .margin({ bottom: 8 })

          Scroll() {
            Row() {
              ForEach(this.categories, (category: Category) => {
                Column() {
                  Text(category.icon)
                    .fontSize(24)
                    .margin({ bottom: 4 })
                  Text(category.name)
                    .fontSize(10)
                    .fontColor(this.selectedCategory === category.name ? this.getColorScheme().CATEGORY_GRID.activeTextColor : this.getColorScheme().CATEGORY_GRID.textColor)
                }
                .width(60)
                .height(80)
                .padding(8)
                .backgroundColor(this.selectedCategory === category.name ? this.getColorScheme().CATEGORY_GRID.activeBackground : this.getColorScheme().CATEGORY_GRID.itemBackground)
                .borderRadius(8)
                .border({
                  width: this.selectedCategory === category.name ? 2 : 0,
                  color: this.getColorScheme().CATEGORY_GRID.activeBorderColor
                })
                .margin({ right: 8 })
                .onClick(() => {
                  this.selectedCategory = category.name;
                })
              }, (category: Category) => category.name)
              
              // æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»æŒ‰é’®
              Column() {
                Text('âž•')
                  .fontSize(24)
                  .margin({ bottom: 4 })
                Text('è‡ªå®šä¹‰')
                  .fontSize(10)
                  .fontColor(this.getColorScheme().CATEGORY_GRID.textColor)
              }
              .width(60)
              .height(80)
              .padding(8)
              .backgroundColor(this.getColorScheme().CATEGORY_GRID.itemBackground)
              .borderRadius(8)
              .border({
                width: 1,
                color: this.getColorScheme().CATEGORY_GRID.activeBorderColor,
                style: BorderStyle.Dashed
              })
              .onClick(() => {
                this.showCustomCategoryDialog = true;
              })
            }
          }
          .width('100%')
          .height(90)
          .scrollable(ScrollDirection.Horizontal)
          .scrollBar(BarState.Off)
          .margin({ bottom: 16 })

          // é‡‘é¢è¾“å…¥
          Text('é‡‘é¢')
            .fontSize(12)
            .fontColor(this.getColorScheme().INPUT_SECTION.labelColor)
            .margin({ bottom: 8 })

          TextInput({ placeholder: 'è¯·è¾“å…¥é‡‘é¢', text: this.amount })
            .type(InputType.Number)
            .width('100%')
            .height(44)
            .padding({ left: 12, right: 12 })
            .backgroundColor(this.getColorScheme().INPUT_SECTION.inputBackground)
            .borderRadius(8)
            .placeholderColor(this.getColorScheme().INPUT_SECTION.placeholderColor)
            .onChange((value: string) => {
              this.amount = value;
            })
            .margin({ bottom: 16 })

          // ç”¨é€”æè¿°
          Text('ç”¨é€”')
            .fontSize(12)
            .fontColor(this.getColorScheme().INPUT_SECTION.labelColor)
            .margin({ bottom: 8 })

          TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨é€”æè¿°' })
            .width('100%')
            .height(44)
            .padding({ left: 12, right: 12 })
            .backgroundColor(this.getColorScheme().INPUT_SECTION.inputBackground)
            .borderRadius(8)
            .placeholderColor(this.getColorScheme().INPUT_SECTION.placeholderColor)
            .onChange((value: string) => {
              this.description = value;
            })
            .margin({ bottom: 16 })

          // æ—¥æœŸé€‰æ‹©
          Text('æ—¥æœŸ')
            .fontSize(12)
            .fontColor(this.getColorScheme().INPUT_SECTION.labelColor)
            .margin({ bottom: 8 })

          TextInput({ placeholder: 'YYYY-MM-DD', text: this.selectedDate })
            .width('100%')
            .height(44)
            .padding({ left: 12, right: 12 })
            .backgroundColor(this.getColorScheme().INPUT_SECTION.inputBackground)
            .borderRadius(8)
            .placeholderColor(this.getColorScheme().INPUT_SECTION.placeholderColor)
            .onChange((value: string) => {
              this.selectedDate = value;
            })
            .onClick(() => {
              DatePickerDialog.show({
                selected: this.selectedDate ? new Date(this.selectedDate) : new Date(),
                onAccept: (value: DatePickerResult) => {
                  if (value.year !== undefined && value.month !== undefined && value.day !== undefined) {
                    const year = value.year;
                    const month = String(value.month + 1).padStart(2, '0');
                    const day = String(value.day).padStart(2, '0');
                    this.selectedDate = `${year}-${month}-${day}`;
                  }
                }
              });
            })
            .margin({ bottom: 16 })

          // å¿ƒæƒ…é€‰æ‹©
          Text('å¿ƒæƒ…')
            .fontSize(12)
            .fontColor(this.getColorScheme().INPUT_SECTION.labelColor)
            .margin({ bottom: 8 })

          Scroll() {
            Row() {
              Button('ðŸ˜Šæ»¡æ„')
                .height(44)
                .padding({ left: 16, right: 16 })
                .backgroundColor(this.selectedMood === 'ðŸ˜Šæ»¡æ„' ? this.getColorScheme().TYPE_SELECTOR.activeBackground : this.getColorScheme().TYPE_SELECTOR.inactiveBackground)
                .fontColor(this.selectedMood === 'ðŸ˜Šæ»¡æ„' ? this.getColorScheme().TYPE_SELECTOR.activeTextColor : this.getColorScheme().TYPE_SELECTOR.inactiveTextColor)
                .onClick(() => {
                  this.selectedMood = 'ðŸ˜Šæ»¡æ„';
                })
                .margin({ right: 8 })

              Button('ðŸ˜ŸåŽæ‚”')
                .height(44)
                .padding({ left: 16, right: 16 })
                .backgroundColor(this.selectedMood === 'ðŸ˜ŸåŽæ‚”' ? this.getColorScheme().TYPE_SELECTOR.activeBackground : this.getColorScheme().TYPE_SELECTOR.inactiveBackground)
                .fontColor(this.selectedMood === 'ðŸ˜ŸåŽæ‚”' ? this.getColorScheme().TYPE_SELECTOR.activeTextColor : this.getColorScheme().TYPE_SELECTOR.inactiveTextColor)
                .onClick(() => {
                  this.selectedMood = 'ðŸ˜ŸåŽæ‚”';
                })
                .margin({ right: 8 })

              Button('ðŸŽ‰æƒŠå–œ')
                .height(44)
                .padding({ left: 16, right: 16 })
                .backgroundColor(this.selectedMood === 'ðŸŽ‰æƒŠå–œ' ? this.getColorScheme().TYPE_SELECTOR.activeBackground : this.getColorScheme().TYPE_SELECTOR.inactiveBackground)
                .fontColor(this.selectedMood === 'ðŸŽ‰æƒŠå–œ' ? this.getColorScheme().TYPE_SELECTOR.activeTextColor : this.getColorScheme().TYPE_SELECTOR.inactiveTextColor)
                .onClick(() => {
                  this.selectedMood = 'ðŸŽ‰æƒŠå–œ';
                })
            }
          }
          .width('100%')
          .scrollable(ScrollDirection.Horizontal)
          .scrollBar(BarState.Off)
          .margin({ bottom: 24 })

          // æŒ‰é’®
          Row() {
            Button('å–æ¶ˆ')
              .width('48%')
              .height(44)
              .backgroundColor(this.getColorScheme().BUTTON_SECTION.cancelBackground)
              .fontColor(this.getColorScheme().BUTTON_SECTION.cancelTextColor)
              .onClick(() => {
                router.back();
              })

            Row()
              .width('4%')

            Button('ä¿å­˜')
              .width('48%')
              .height(44)
              .backgroundColor(this.getColorScheme().BUTTON_SECTION.saveBackground)
              .fontColor(this.getColorScheme().BUTTON_SECTION.saveTextColor)
              .onClick(() => {
                this.saveRecord();
              })
          }
          .width('100%')
        }
        .width('100%')
        .padding(16)
      }
        .width('100%')
        .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(COLORS.background)
      
      // è‡ªå®šä¹‰åˆ†ç±»å¯¹è¯æ¡†
      if (this.showCustomCategoryDialog) {
        Column() {
          Column() {
            Text('æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getColorScheme().DIALOG.titleColor)
              .margin({ bottom: 16 })

            TextInput({ placeholder: 'è¯·è¾“å…¥åˆ†ç±»åç§°', text: this.customCategoryName })
              .width('100%')
              .height(44)
              .backgroundColor(this.getColorScheme().INPUT_SECTION.inputBackground)
              .borderRadius(8)
              .onChange((value: string) => {
                this.customCategoryName = value;
              })
              .margin({ bottom: 16 })

            Row() {
              Button('å–æ¶ˆ')
                .width('48%')
                .height(40)
                .backgroundColor(this.getColorScheme().BUTTON_SECTION.cancelBackground)
                .fontColor(this.getColorScheme().BUTTON_SECTION.cancelTextColor)
                .onClick(() => {
                  this.showCustomCategoryDialog = false;
                  this.customCategoryName = '';
                })

              Row().width('4%')

              Button('ç¡®å®š')
                .width('48%')
                .height(40)
                .backgroundColor(this.getColorScheme().BUTTON_SECTION.saveBackground)
                .fontColor(this.getColorScheme().BUTTON_SECTION.saveTextColor)
                .onClick(async () => {
                  if (this.customCategoryName) {
                    // æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»åˆ°å­˜å‚¨
                    const newCategory: Category = {
                      name: this.customCategoryName,
                      icon: 'ðŸ“Œ',
                      color: '#B8B5B2'
                    };
                    await CategoryUtil.addCustomCategory(newCategory);
                    
                    // é‡æ–°åŠ è½½åˆ†ç±»åˆ—è¡¨
                    await this.updateCategories();
                    this.selectedCategory = this.customCategoryName;
                    this.showCustomCategoryDialog = false;
                    this.customCategoryName = '';
                    
                    promptAction.showToast({
                      message: 'è‡ªå®šä¹‰åˆ†ç±»å·²æ·»åŠ ',
                      duration: 1500
                    });
                  }
                })
            }
            .width('100%')
          }
          .width('80%')
          .padding(20)
          .backgroundColor(this.getColorScheme().DIALOG.backgroundColor)
          .borderRadius(12)
          .shadow({ radius: 20, color: '#00000040' })
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#00000040')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showCustomCategoryDialog = false;
        })
      }
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
    .backgroundImage(ThemeUtil.getBackgroundImage(ThemeUtil.getTheme()))
    .backgroundImageSize(ImageSize.Cover)
    .backgroundImagePosition(Alignment.Center)
  }
}
