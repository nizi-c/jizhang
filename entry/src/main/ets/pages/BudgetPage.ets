// é¢„ç®—ç®¡ç†é¡µé¢
import { Budget, BudgetProgress } from '../models/Budget';
import { AccountRecord } from '../models/AccountRecord';
import { BudgetUtil } from '../utils/BudgetUtil';
import { StorageUtil } from '../utils/StorageUtil';
import { ThemeUtil } from '../utils/ThemeUtil';
import { CategoryUtil } from '../utils/CategoryUtil';
import { LIGHT_COLOR_SCHEME, DARK_COLOR_SCHEME } from '../constants/ColorSchemes';
import { EXPENSE_CATEGORIES, Category } from '../constants/Constants';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';

@Entry
@Component
struct BudgetPage {
  @State budgets: Budget[] = [];
  @State records: AccountRecord[] = [];
  @State budgetProgresses: BudgetProgress[] = [];
  @State showAddDialog: boolean = false;
  @State newCategory: string = '';
  @State newAmount: string = '';
  @State newPeriod: 'week' | 'month' | 'year' = 'month';
  @State totalBudget: number = 0;
  @State totalUsed: number = 0;
  @State totalRemaining: number = 0;
  @State totalPercentage: number = 0;
  @State availableCategories: Category[] = [];
  @State showCustomCategoryDialog: boolean = false;
  @State customCategoryName: string = '';

  async aboutToAppear() {
    const context = getContext(this) as common.UIAbilityContext;
    await BudgetUtil.init(context);
    await this.loadData();
    await this.loadCategories();
  }

  async loadData() {
    this.budgets = await BudgetUtil.getAllBudgets();
    this.records = await StorageUtil.getRecords();
    this.calculateProgress();
  }

  async loadCategories() {
    const customCategories = await CategoryUtil.getCustomCategories();
    this.availableCategories = [...EXPENSE_CATEGORIES, ...customCategories];
  }

  calculateProgress() {
    this.budgetProgresses = [];
    this.totalBudget = 0;
    this.totalUsed = 0;

    this.budgets.forEach(budget => {
      const usedAmount = this.records
        .filter(r => r.category === budget.category && r.type === 'expense')
        .reduce((sum, r) => sum + r.amount, 0);

      const remainingAmount = budget.amount - usedAmount;
      const percentage = budget.amount > 0 ? (usedAmount / budget.amount) * 100 : 0;
      const status = percentage > 100 ? 'exceeded' :
                     percentage >= budget.warningThreshold ? 'warning' : 'normal';

      this.budgetProgresses.push({
        budgetId: budget.id,
        category: budget.category,
        budgetAmount: budget.amount,
        usedAmount: usedAmount,
        remainingAmount: remainingAmount,
        percentage: percentage,
        status: status,
        recordCount: this.records.filter(r => r.category === budget.category).length
      });

      this.totalBudget += budget.amount;
      this.totalUsed += usedAmount;
    });

    this.totalRemaining = this.totalBudget - this.totalUsed;
    this.totalPercentage = this.totalBudget > 0 ? (this.totalUsed / this.totalBudget) * 100 : 0;
  }

  async addBudget() {
    if (!this.newCategory || !this.newAmount) {
      promptAction.showToast({ message: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', duration: 2000 });
      return;
    }

    const amount = parseFloat(this.newAmount);
    if (isNaN(amount) || amount <= 0) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢', duration: 2000 });
      return;
    }

    const budget: Budget = {
      id: '',
      bookId: '',
      category: this.newCategory,
      amount: amount,
      period: this.newPeriod,
      warningThreshold: 90,
      createTime: ''
    };

    await BudgetUtil.saveBudget(budget);
    await this.loadData();

    this.showAddDialog = false;
    this.newCategory = '';
    this.newAmount = '';
    this.newPeriod = 'month';

    promptAction.showToast({ message: 'æ·»åŠ æˆåŠŸ', duration: 1500 });
  }

  async deleteBudget(budgetId: string) {
    await BudgetUtil.deleteBudget(budgetId);
    await this.loadData();
    promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ', duration: 1500 });
  }

  getColorScheme() {
    return ThemeUtil.getTheme() === 'light' ? LIGHT_COLOR_SCHEME : DARK_COLOR_SCHEME;
  }

  getProgressColor(status: string): string {
    switch (status) {
      case 'normal':
        return this.getColorScheme().STAT_CARD.incomeColor;
      case 'warning':
        return '#FFA500';
      case 'exceeded':
        return this.getColorScheme().STAT_CARD.expenseColor;
      default:
        return this.getColorScheme().STAT_CARD.incomeColor;
    }
  }

  getCategoryColor(category: string): string {
    const colors = [
      '#E8A5A5', // é£Ÿç‰© - çº¢è‰²ç³»
      '#8FAADC', // äº¤é€š - è“è‰²ç³»
      '#E8C9A5', // å¨±ä¹ - æ©™è‰²ç³»
      '#C9B6D6', // è´­ç‰© - ç´«è‰²ç³»
      '#95D1B3', // åŒ»ç–— - ç»¿è‰²ç³»
      '#A5C8E8', // æ•™è‚² - æµ…è“è‰²
      '#B8B5B2', // ä½æˆ¿ - ç°è‰²ç³»
      '#D6C9B6', // å…¶ä»– - æ£•è‰²ç³»
      '#FFB6C1', // é¢å¤–é¢œè‰²1
      '#98D8C8'  // é¢å¤–é¢œè‰²2
    ];
    
    // æ ¹æ®åˆ†ç±»åç§°ç”Ÿæˆä¸€ä¸ªç¨³å®šçš„ç´¢å¼•
    let hash = 0;
    for (let i = 0; i < category.length; i++) {
      hash = category.charCodeAt(i) + ((hash << 5) - hash);
    }
    const index = Math.abs(hash) % colors.length;
    return colors[index];
  }

  build() {
    Stack() {
      Column() {
        // å¯¼èˆªæ 
        Row() {
          Button({ type: ButtonType.Circle }) {
            Text('â†').fontSize(20).fontColor(this.getColorScheme().NAVBAR.backButtonColor)
          }
          .width(36).height(36)
          .backgroundColor(this.getColorScheme().NAVBAR.backgroundColor)
          .onClick(() => router.back())

          Text('é¢„ç®—ç®¡ç†')
            .fontSize(18).fontWeight(FontWeight.Bold)
            .fontColor(this.getColorScheme().NAVBAR.titleColor)
            .layoutWeight(1).textAlign(TextAlign.Center)

          Button({ type: ButtonType.Circle }) {
            Text('+').fontSize(24).fontColor(this.getColorScheme().NAVBAR.titleColor)
          }
          .width(36).height(36)
          .backgroundColor(this.getColorScheme().NAVBAR.buttonBackground)
          .onClick(() => { this.showAddDialog = true; })
        }
        .width('100%').padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .backgroundColor(this.getColorScheme().NAVBAR.backgroundColor)
        .border({ width: { bottom: 1 }, color: this.getColorScheme().NAVBAR.borderColor })

      Scroll() {
        Column() {
          // æ€»ä½“æ¦‚è§ˆ
          Column() {
            Text('æœ¬æœˆé¢„ç®—æ¦‚è§ˆ')
              .fontSize(16).fontWeight(FontWeight.Bold)
              .fontColor(this.getColorScheme().CHART_CONTAINER.titleColor)
              .margin({ bottom: 12 })

            Row() {
              Column() {
                Text('æ€»é¢„ç®—').fontSize(12).fontColor(this.getColorScheme().STAT_CARD.labelColor)
                Text(`Â¥${this.totalBudget.toFixed(0)}`)
                  .fontSize(18).fontWeight(FontWeight.Bold)
                  .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
              }.layoutWeight(1)

              Column() {
                Text('å·²ä½¿ç”¨').fontSize(12).fontColor(this.getColorScheme().STAT_CARD.labelColor)
                Text(`Â¥${this.totalUsed.toFixed(0)}`)
                  .fontSize(18).fontWeight(FontWeight.Bold)
                  .fontColor(this.getColorScheme().STAT_CARD.expenseColor)
              }.layoutWeight(1)

              Column() {
                Text('å‰©ä½™').fontSize(12).fontColor(this.getColorScheme().STAT_CARD.labelColor)
                Text(`Â¥${this.totalRemaining.toFixed(0)}`)
                  .fontSize(18).fontWeight(FontWeight.Bold)
                  .fontColor(this.getColorScheme().STAT_CARD.incomeColor)
              }.layoutWeight(1)
            }.width('100%').margin({ bottom: 12 })

            Progress({ value: this.totalPercentage, total: 100, type: ProgressType.Linear })
              .width('100%').height(8)
              .color(this.totalPercentage > 100 ? this.getColorScheme().STAT_CARD.expenseColor :
                     this.totalPercentage >= 80 ? '#FFA500' :
                     this.getColorScheme().STAT_CARD.incomeColor)

            Text(`${this.totalPercentage.toFixed(1)}%`)
              .fontSize(14).fontColor(this.getColorScheme().LIST_ITEM.descriptionColor)
              .margin({ top: 8 })
          }
          .width('100%').padding(16)
          .backgroundColor(this.getColorScheme().STAT_CARD.backgroundColor)
          .borderRadius(12).margin({ bottom: 16 })

          // é¢„ç®—å æ¯”ç¯å½¢å›¾
          if (this.budgetProgresses.length > 0) {
            this.buildBudgetPieChart()
          }

          // é¢„ç®—åˆ—è¡¨
          if (this.budgetProgresses.length === 0) {
            Column() {
              Text('æš‚æ— é¢„ç®—è®¾ç½®')
                .fontSize(16).fontColor(this.getColorScheme().LIST_CONTAINER.emptyTextColor)
                .margin({ top: 40 })
            }.width('100%')
          } else {
            ForEach(this.budgetProgresses, (progress: BudgetProgress) => {
              this.buildBudgetItem(progress)
            }, (progress: BudgetProgress) => progress.budgetId)
          }
        }
        .width('100%').padding(16)
      }
      .layoutWeight(1)
      }
      .width('100%').height('100%')
      .backgroundImage(ThemeUtil.getBackgroundImage(ThemeUtil.getTheme()))
      .backgroundImageSize(ImageSize.Cover)
      .backgroundImagePosition(Alignment.Center)

      // æ·»åŠ é¢„ç®—å¯¹è¯æ¡†
      if (this.showAddDialog) {
        this.buildAddDialog()
      }

      // è‡ªå®šä¹‰åˆ†ç±»å¯¹è¯æ¡†
      if (this.showCustomCategoryDialog) {
        this.buildCustomCategoryDialog()
      }
    }
    .width('100%').height('100%')
    .alignContent(Alignment.Center)
  }

  @Builder
  buildBudgetPieChart() {
    Column() {
      Text('é¢„ç®—åˆ†ç±»å æ¯”')
        .fontSize(16).fontWeight(FontWeight.Bold)
        .fontColor(this.getColorScheme().CHART_CONTAINER.titleColor)
        .margin({ bottom: 16 })

      // ç¯å½¢å›¾å¯è§†åŒ–
      Stack() {
        ForEach(this.budgetProgresses.slice(0, 5), (progress: BudgetProgress, index: number) => {
          Progress({
            value: (progress.budgetAmount / this.totalBudget) * 100,
            total: 100,
            type: ProgressType.Ring
          })
            .width(180 - index * 20)
            .height(180 - index * 20)
            .color(this.getCategoryColor(progress.category))
            .style({ strokeWidth: 15 })
        }, (progress: BudgetProgress) => progress.budgetId)

        // ä¸­å¿ƒæ˜¾ç¤ºæ€»é¢„ç®—
        Column() {
          Text('æ€»é¢„ç®—')
            .fontSize(12)
            .fontColor(this.getColorScheme().LIST_ITEM.descriptionColor)
          Text(`Â¥${this.totalBudget.toFixed(0)}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
        }
      }
      .width('100%')
      .height(180)
      .alignContent(Alignment.Center)
      .margin({ bottom: 16 })

      // å›¾ä¾‹
      Column() {
        ForEach(this.budgetProgresses, (progress: BudgetProgress) => {
          Row() {
            Row()
              .width(12)
              .height(12)
              .backgroundColor(this.getCategoryColor(progress.category))
              .borderRadius(2)
              .margin({ right: 8 })

            Text(progress.category)
              .fontSize(14)
              .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
              .layoutWeight(1)

            Text(`${((progress.budgetAmount / this.totalBudget) * 100).toFixed(1)}%`)
              .fontSize(12)
              .fontColor(this.getColorScheme().LIST_ITEM.descriptionColor)
              .margin({ right: 8 })

            Text(`Â¥${progress.budgetAmount.toFixed(0)}`)
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
          }
          .width('100%')
          .padding(12)
          .backgroundColor(this.getColorScheme().LIST_ITEM.backgroundColor)
          .borderRadius(8)
          .margin({ bottom: 8 })
        }, (progress: BudgetProgress) => progress.budgetId)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.getColorScheme().CHART_CONTAINER.backgroundColor)
    .borderRadius(12)
    .margin({ bottom: 16 })
  }

  @Builder
  buildBudgetItem(progress: BudgetProgress) {
    Column() {
      Row() {
        Row() {
          Text(progress.category)
            .fontSize(16).fontWeight(FontWeight.Bold)
            .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
          
          // è¶…æ”¯æˆ–é¢„è­¦æ ‡è¯†
          if (progress.status === 'exceeded' || progress.status === 'warning') {
            Image($r('app.media.clock'))
              .width(16).height(16)
              .margin({ left: 6 })
            Text(progress.status === 'exceeded' ? 'è¶…æ”¯' : 'é¢„è­¦')
              .fontSize(12)
              .fontColor(progress.status === 'exceeded' ? 
                this.getColorScheme().STAT_CARD.expenseColor : '#FFA500')
              .fontWeight(FontWeight.Bold)
              .margin({ left: 2 })
          }
        }.layoutWeight(1)

        Button('åˆ é™¤')
          .fontSize(12).height(28)
          .backgroundColor('#E8A5A5').fontColor('#FFFFFF')
          .onClick(() => { this.deleteBudget(progress.budgetId); })
      }.width('100%').margin({ bottom: 8 })

      Row() {
        Text(`Â¥${progress.usedAmount.toFixed(0)}`)
          .fontSize(14).fontColor(this.getColorScheme().STAT_CARD.expenseColor)
        Text(' / ')
          .fontSize(14).fontColor(this.getColorScheme().LIST_ITEM.descriptionColor)
        Text(`Â¥${progress.budgetAmount.toFixed(0)}`)
          .fontSize(14).fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
      }.width('100%').margin({ bottom: 8 })

      Progress({ value: Math.min(progress.percentage, 100), total: 100, type: ProgressType.Linear })
        .width('100%').height(8)
        .color(this.getProgressColor(progress.status))
        .margin({ bottom: 8 })

      Row() {
        Text(`${progress.percentage.toFixed(1)}%`)
          .fontSize(12).fontColor(this.getColorScheme().LIST_ITEM.descriptionColor)
        Text(progress.status === 'exceeded' ? `è¶…æ”¯ Â¥${Math.abs(progress.remainingAmount).toFixed(0)}` :
             `å‰©ä½™ Â¥${progress.remainingAmount.toFixed(0)}`)
          .fontSize(12)
          .fontColor(progress.status === 'exceeded' ?
            this.getColorScheme().STAT_CARD.expenseColor :
            this.getColorScheme().STAT_CARD.incomeColor)
          .layoutWeight(1).textAlign(TextAlign.End)
      }.width('100%')
    }
    .width('100%').padding(16)
    .backgroundColor(this.getColorScheme().LIST_ITEM.backgroundColor)
    .borderRadius(12).margin({ bottom: 12 })
  }

  @Builder
  buildAddDialog() {
    Column() {
      Column() {
        Text('æ·»åŠ é¢„ç®—')
          .fontSize(18).fontWeight(FontWeight.Bold)
          .fontColor(this.getColorScheme().DIALOG.titleColor)
          .margin({ bottom: 20 })

        Text('åˆ†ç±»').fontSize(14).fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
          .alignSelf(ItemAlign.Start).margin({ bottom: 8 })

        Scroll() {
          Row() {
            ForEach(this.availableCategories, (cat: Category) => {
              Button() {
                Column() {
                  Text(cat.icon).fontSize(20)
                  Text(cat.name).fontSize(10).fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
                }
              }
              .width(60).height(60)
              .backgroundColor(this.newCategory === cat.name ?
                this.getColorScheme().TYPE_SELECTOR.activeBackground :
                this.getColorScheme().LIST_ITEM.backgroundColor)
              .borderRadius(8).margin({ right: 8 })
              .onClick(() => { this.newCategory = cat.name; })
            }, (cat: Category) => cat.name)
            
            // æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»æŒ‰é’®
            Column() {
              Text('â•')
                .fontSize(24)
                .margin({ bottom: 4 })
              Text('è‡ªå®šä¹‰')
                .fontSize(10)
                .fontColor(this.getColorScheme().CATEGORY_GRID.textColor)
            }
            .width(60)
            .height(60)
            .padding(8)
            .backgroundColor(this.getColorScheme().CATEGORY_GRID.itemBackground)
            .borderRadius(8)
            .border({
              width: 1,
              color: this.getColorScheme().CATEGORY_GRID.activeBorderColor,
              style: BorderStyle.Dashed
            })
            .onClick(() => {
              this.showCustomCategoryDialog = true;
            })
          }
        }
        .scrollable(ScrollDirection.Horizontal).scrollBar(BarState.Off)
        .width('100%').margin({ bottom: 16 })

        Text('é‡‘é¢').fontSize(14).fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
          .alignSelf(ItemAlign.Start).margin({ bottom: 8 })

        TextInput({ placeholder: 'è¯·è¾“å…¥é¢„ç®—é‡‘é¢', text: this.newAmount })
          .type(InputType.Number).width('100%').height(44)
          .backgroundColor(this.getColorScheme().LIST_ITEM.backgroundColor)
          .placeholderColor('#999999')
          .onChange((value: string) => { this.newAmount = value; })
          .margin({ bottom: 16 })

        Text('å‘¨æœŸ').fontSize(14).fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
          .alignSelf(ItemAlign.Start).margin({ bottom: 8 })

        Row() {
          Button('å‘¨')
            .width('30%').height(36)
            .backgroundColor(this.newPeriod === 'week' ?
              this.getColorScheme().TYPE_SELECTOR.activeBackground :
              this.getColorScheme().LIST_ITEM.backgroundColor)
            .fontColor(this.newPeriod === 'week' ? '#FFFFFF' :
              this.getColorScheme().LIST_ITEM.categoryColor)
            .onClick(() => { this.newPeriod = 'week'; })
            .margin({ right: 8 })

          Button('æœˆ')
            .width('30%').height(36)
            .backgroundColor(this.newPeriod === 'month' ?
              this.getColorScheme().TYPE_SELECTOR.activeBackground :
              this.getColorScheme().LIST_ITEM.backgroundColor)
            .fontColor(this.newPeriod === 'month' ? '#FFFFFF' :
              this.getColorScheme().LIST_ITEM.categoryColor)
            .onClick(() => { this.newPeriod = 'month'; })
            .margin({ right: 8 })

          Button('å¹´')
            .width('30%').height(36)
            .backgroundColor(this.newPeriod === 'year' ?
              this.getColorScheme().TYPE_SELECTOR.activeBackground :
              this.getColorScheme().LIST_ITEM.backgroundColor)
            .fontColor(this.newPeriod === 'year' ? '#FFFFFF' :
              this.getColorScheme().LIST_ITEM.categoryColor)
            .onClick(() => { this.newPeriod = 'year'; })
        }.width('100%').margin({ bottom: 20 })

        Row() {
          Button('å–æ¶ˆ')
            .width('48%').height(44)
            .backgroundColor(this.getColorScheme().LIST_ITEM.backgroundColor)
            .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
            .onClick(() => {
              this.showAddDialog = false;
              this.newCategory = '';
              this.newAmount = '';
            })

          Button('ç¡®å®š')
            .width('48%').height(44)
            .backgroundColor(this.getColorScheme().TYPE_SELECTOR.activeBackground)
            .fontColor('#FFFFFF')
            .onClick(() => { this.addBudget(); })
        }.width('100%').justifyContent(FlexAlign.SpaceBetween)
      }
      .width('85%').padding(20)
      .backgroundColor(this.getColorScheme().DIALOG.backgroundColor)
      .borderRadius(12).shadow({ radius: 20, color: '#00000040' })
    }
    .width('100%').height('100%')
    .backgroundColor('#00000040')
    .justifyContent(FlexAlign.Center)
    .onClick(() => { this.showAddDialog = false; })
  }

  @Builder
  buildCustomCategoryDialog() {
    Column() {
      Column() {
        Text('æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getColorScheme().DIALOG.titleColor)
          .margin({ bottom: 16 })

        TextInput({ placeholder: 'è¯·è¾“å…¥åˆ†ç±»åç§°', text: this.customCategoryName })
          .width('100%')
          .height(44)
          .backgroundColor(this.getColorScheme().INPUT_SECTION.inputBackground)
          .borderRadius(8)
          .onChange((value: string) => {
            this.customCategoryName = value;
          })
          .margin({ bottom: 16 })

        Row() {
          Button('å–æ¶ˆ')
            .width('48%')
            .height(40)
            .backgroundColor(this.getColorScheme().BUTTON_SECTION.cancelBackground)
            .fontColor(this.getColorScheme().BUTTON_SECTION.cancelTextColor)
            .onClick(() => {
              this.showCustomCategoryDialog = false;
              this.customCategoryName = '';
            })

          Row().width('4%')

          Button('ç¡®å®š')
            .width('48%')
            .height(40)
            .backgroundColor(this.getColorScheme().BUTTON_SECTION.saveBackground)
            .fontColor(this.getColorScheme().BUTTON_SECTION.saveTextColor)
            .onClick(async () => {
              if (this.customCategoryName) {
                // æ·»åŠ è‡ªå®šä¹‰åˆ†ç±»åˆ°å­˜å‚¨
                const newCategory: Category = {
                  name: this.customCategoryName,
                  icon: 'ğŸ“Œ',
                  color: '#B8B5B2'
                };
                await CategoryUtil.addCustomCategory(newCategory);
                
                // é‡æ–°åŠ è½½åˆ†ç±»åˆ—è¡¨
                await this.loadCategories();
                this.newCategory = this.customCategoryName;
                this.showCustomCategoryDialog = false;
                this.customCategoryName = '';
                
                promptAction.showToast({
                  message: 'è‡ªå®šä¹‰åˆ†ç±»å·²æ·»åŠ ',
                  duration: 1500
                });
              }
            })
        }
        .width('100%')
      }
      .width('80%')
      .padding(20)
      .backgroundColor(this.getColorScheme().DIALOG.backgroundColor)
      .borderRadius(12)
      .shadow({ radius: 20, color: '#00000040' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#00000040')
    .justifyContent(FlexAlign.Center)
    .onClick(() => { this.showCustomCategoryDialog = false; })
  }
}
