// è´¦æœ¬ç®¡ç†é¡µé¢
import { AccountBook } from '../models/AccountBook';
import { AccountBookUtil } from '../utils/AccountBookUtil';
import { ThemeUtil } from '../utils/ThemeUtil';
import { LIGHT_COLOR_SCHEME, DARK_COLOR_SCHEME } from '../constants/ColorSchemes';
import { EventBus, Events } from '../utils/EventBus';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import common from '@ohos.app.ability.common';

@Entry
@Component
struct AccountBooksPage {
  @State books: AccountBook[] = [];
  @State currentBookId: string = '';
  @State showCreateDialog: boolean = false;
  @State showRenameDialog: boolean = false;
  @State newBookName: string = '';
  @State newBookIcon: string = 'ðŸ“’';
  @State renameBook: AccountBook | null = null;
  @State renameBookName: string = '';

  private bookIcons: string[] = ['ðŸ“’', 'ðŸ’°', 'ðŸ’³', 'ðŸ¦', 'ðŸ“Š', 'ðŸ’µ', 'ðŸŽ¯', 'ðŸ“', 'ðŸ”–', 'ðŸ“Œ'];
  private scroller: Scroller = new Scroller();

  aboutToAppear() {
    // ç¡®ä¿AccountBookUtilå·²åˆå§‹åŒ–
    const context = getContext(this) as common.UIAbilityContext;
    if (!AccountBookUtil.getCurrentBookId()) {
      AccountBookUtil.init(context).then(() => {
        this.loadBooks();
      });
    } else {
      this.loadBooks();
    }
    
    // æ»šåŠ¨åˆ°é¡¶éƒ¨
    setTimeout(() => {
      this.scroller.scrollEdge(Edge.Top);
    }, 200);
  }

  loadBooks() {
    AccountBookUtil.getAllBooks().then((books: AccountBook[]) => {
      this.books = [...books];
      this.currentBookId = AccountBookUtil.getCurrentBookId();
      console.log('AccountBooksPage: è´¦æœ¬åˆ—è¡¨å·²åŠ è½½ï¼Œæ€»æ•°:', this.books.length);
    }).catch((error: Error) => {
      console.error('AccountBooksPage: åŠ è½½è´¦æœ¬å¤±è´¥:', error);
    });
  }

  getColorScheme() {
    return ThemeUtil.getTheme() === 'light' ? LIGHT_COLOR_SCHEME : DARK_COLOR_SCHEME;
  }

  switchBook(bookId: string) {
    AccountBookUtil.setCurrentBook(bookId).then(() => {
      this.currentBookId = bookId;
      console.log('AccountBooksPage: å·²åˆ‡æ¢è´¦æœ¬:', bookId);
      
      // å‘é€è´¦æœ¬åˆ‡æ¢äº‹ä»¶
      EventBus.emit(Events.BOOK_SWITCHED, bookId);
      
      promptAction.showToast({
        message: 'å·²åˆ‡æ¢è´¦æœ¬',
        duration: 1500
      });
      
      // å»¶è¿Ÿè¿”å›žé¦–é¡µåˆ·æ–°æ•°æ®
      setTimeout(() => {
        console.log('AccountBooksPage: è¿”å›žé¦–é¡µ');
        router.back();
      }, 1200);
    });
  }

  createBook() {
    if (!this.newBookName.trim()) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥è´¦æœ¬åç§°',
        duration: 2000
      });
      return;
    }

    AccountBookUtil.createBook(this.newBookName.trim(), this.newBookIcon).then(() => {
      this.loadBooks();
      
      this.showCreateDialog = false;
      this.newBookName = '';
      this.newBookIcon = 'ðŸ“’';
      
      promptAction.showToast({
        message: 'åˆ›å»ºæˆåŠŸ',
        duration: 1500
      });
    }).catch((error: Error) => {
      console.error('AccountBooksPage: åˆ›å»ºè´¦æœ¬å¤±è´¥:', error);
      promptAction.showToast({
        message: 'åˆ›å»ºå¤±è´¥',
        duration: 2000
      });
    });
  }

  deleteBook(book: AccountBook) {
    if (book.isDefault) {
      promptAction.showToast({
        message: 'ä¸èƒ½åˆ é™¤é»˜è®¤è´¦æœ¬',
        duration: 2000
      });
      return;
    }

    if (book.id === this.currentBookId) {
      promptAction.showToast({
        message: 'ä¸èƒ½åˆ é™¤å½“å‰è´¦æœ¬',
        duration: 2000
      });
      return;
    }

    AccountBookUtil.deleteBook(book.id).then((success: boolean) => {
      if (success) {
        this.loadBooks();
        promptAction.showToast({
          message: 'åˆ é™¤æˆåŠŸ',
          duration: 1500
        });
      } else {
        promptAction.showToast({
          message: 'åˆ é™¤å¤±è´¥',
          duration: 2000
        });
      }
    });
  }

  showRenameBookDialog(book: AccountBook) {
    this.renameBook = book;
    this.renameBookName = book.name;
    this.showRenameDialog = true;
  }

  renameBookConfirm() {
    if (!this.renameBook) return;

    if (!this.renameBookName.trim()) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥è´¦æœ¬åç§°',
        duration: 2000
      });
      return;
    }

    this.renameBook.name = this.renameBookName.trim();
    AccountBookUtil.saveBook(this.renameBook).then(() => {
      this.loadBooks();
      console.log('AccountBooksPage: è´¦æœ¬å·²é‡å‘½åä¸º:', this.renameBook?.name);

      promptAction.showToast({
        message: 'é‡å‘½åæˆåŠŸ',
        duration: 1500
      });

      // å‘é€è´¦æœ¬æ›´æ–°äº‹ä»¶
      console.log('AccountBooksPage: å‘é€ BOOK_UPDATED äº‹ä»¶');
      if (this.renameBook) {
        EventBus.emit(Events.BOOK_UPDATED, this.renameBook);
      }

      this.showRenameDialog = false;
      this.renameBook = null;
      this.renameBookName = '';

      // å»¶è¿Ÿè¿”å›žï¼Œç¡®ä¿äº‹ä»¶å·²è¢«å¤„ç†
      setTimeout(() => {
        console.log('AccountBooksPage: è¿”å›žé¦–é¡µ');
        router.back();
      }, 1200);
    }).catch((error: Error) => {
      console.error('AccountBooksPage: é‡å‘½åå¤±è´¥:', error);
      promptAction.showToast({
        message: 'é‡å‘½åå¤±è´¥',
        duration: 2000
      });
    });
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('â†')
            .fontSize(20)
            .fontColor(this.getColorScheme().NAVBAR.backButtonColor)
        }
        .width(36)
        .height(36)
        .backgroundColor(this.getColorScheme().NAVBAR.backgroundColor)
        .onClick(() => {
          router.back();
        })

        Text('è´¦æœ¬ç®¡ç†')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getColorScheme().NAVBAR.titleColor)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Button({ type: ButtonType.Circle, stateEffect: true }) {
          Text('+')
            .fontSize(24)
            .fontColor(this.getColorScheme().NAVBAR.titleColor)
        }
        .width(36)
        .height(36)
        .backgroundColor(this.getColorScheme().NAVBAR.buttonBackground)
        .onClick(() => {
          this.showCreateDialog = true;
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor(this.getColorScheme().NAVBAR.backgroundColor)
      .border({ width: { bottom: 1 }, color: this.getColorScheme().NAVBAR.borderColor })

      // è´¦æœ¬åˆ—è¡¨
      Scroll(this.scroller) {
        Column() {
          if (this.books.length === 0) {
            Column() {
              Text('æš‚æ— è´¦æœ¬')
                .fontSize(16)
                .fontColor(this.getColorScheme().LIST_CONTAINER.emptyTextColor)
                .margin({ top: 40 })
            }
            .width('100%')
          } else {
            ForEach(this.books, (book: AccountBook) => {
              this.buildBookItem(book)
            }, (book: AccountBook) => book.id)
          }
        }
        .width('100%')
        .padding({ top: 8, left: 16, right: 16, bottom: 16 })
      }
      .scrollable(ScrollDirection.Vertical)
      .edgeEffect(EdgeEffect.Spring)
      .align(Alignment.Top)
      .layoutWeight(1)

      // åˆ›å»ºè´¦æœ¬å¯¹è¯æ¡†
      if (this.showCreateDialog) {
        this.buildCreateDialog()
      }

      // é‡å‘½åå¯¹è¯æ¡†
      if (this.showRenameDialog) {
        this.buildRenameDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundImage(ThemeUtil.getBackgroundImage(ThemeUtil.getTheme()))
    .backgroundImageSize(ImageSize.Cover)
    .backgroundImagePosition(Alignment.Center)
  }

  @Builder
  buildBookItem(book: AccountBook) {
    Row() {
      // å›¾æ ‡
      Text(book.icon)
        .fontSize(32)
        .margin({ right: 16 })

      // åç§°å’Œä¿¡æ¯
      Column() {
        Row() {
          Text(book.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
            .onClick(() => {
              this.showRenameBookDialog(book);
            })
          
          if (book.isDefault) {
            Text('é»˜è®¤')
              .fontSize(10)
              .fontColor('#FFFFFF')
              .backgroundColor(this.getColorScheme().STAT_CARD.incomeColor)
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(4)
              .margin({ left: 8 })
          }

          if (book.id === this.currentBookId) {
            Text('å½“å‰')
              .fontSize(10)
              .fontColor('#FFFFFF')
              .backgroundColor('#7B9BC8')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(4)
              .margin({ left: 8 })
          }
        }

        Text(`åˆ›å»ºäºŽ ${this.formatDate(book.createTime)}`)
          .fontSize(12)
          .fontColor(this.getColorScheme().LIST_ITEM.descriptionColor)
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // æ“ä½œæŒ‰é’®
      Row() {
        if (book.id !== this.currentBookId) {
          Button('åˆ‡æ¢')
            .fontSize(14)
            .height(32)
            .backgroundColor(this.getColorScheme().NAVBAR.buttonBackground)
            .fontColor(this.getColorScheme().NAVBAR.titleColor)
            .onClick(() => {
              this.switchBook(book.id);
            })
            .margin({ right: 8 })
        }

        if (!book.isDefault && book.id !== this.currentBookId) {
          Button('åˆ é™¤')
            .fontSize(14)
            .height(32)
            .backgroundColor('#E8A5A5')
            .fontColor('#FFFFFF')
            .onClick(() => {
              this.deleteBook(book);
            })
        }
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.getColorScheme().LIST_ITEM.backgroundColor)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({ radius: 4, color: this.getColorScheme().STAT_CARD.shadowColor })
  }

  @Builder
  buildCreateDialog() {
    Column() {
      Column() {
        Text('åˆ›å»ºæ–°è´¦æœ¬')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getColorScheme().DIALOG.titleColor)
          .margin({ bottom: 20 })

        // è´¦æœ¬åç§°
        Text('è´¦æœ¬åç§°')
          .fontSize(14)
          .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        TextInput({ placeholder: 'è¯·è¾“å…¥è´¦æœ¬åç§°', text: this.newBookName })
          .width('100%')
          .height(44)
          .backgroundColor(this.getColorScheme().LIST_ITEM.backgroundColor)
          .onChange((value: string) => {
            this.newBookName = value;
          })
          .margin({ bottom: 16 })

        // é€‰æ‹©å›¾æ ‡
        Text('é€‰æ‹©å›¾æ ‡')
          .fontSize(14)
          .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        Grid() {
          ForEach(this.bookIcons, (icon: string) => {
            GridItem() {
              Text(icon)
                .fontSize(32)
                .width(60)
                .height(60)
                .textAlign(TextAlign.Center)
                .backgroundColor(this.newBookIcon === icon ? 
                  this.getColorScheme().TYPE_SELECTOR.activeBackground : 
                  this.getColorScheme().LIST_ITEM.backgroundColor)
                .borderRadius(8)
                .onClick(() => {
                  this.newBookIcon = icon;
                })
            }
          }, (icon: string) => icon)
        }
        .columnsTemplate('1fr 1fr 1fr 1fr 1fr')
        .rowsGap(8)
        .columnsGap(8)
        .width('100%')
        .height(140)
        .margin({ bottom: 20 })

        // æŒ‰é’®
        Row() {
          Button('å–æ¶ˆ')
            .width('48%')
            .height(44)
            .backgroundColor(this.getColorScheme().LIST_ITEM.backgroundColor)
            .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
            .onClick(() => {
              this.showCreateDialog = false;
              this.newBookName = '';
              this.newBookIcon = 'ðŸ“’';
            })

          Button('åˆ›å»º')
            .width('48%')
            .height(44)
            .backgroundColor(this.getColorScheme().TYPE_SELECTOR.activeBackground)
            .fontColor('#FFFFFF')
            .onClick(() => {
              this.createBook();
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('85%')
      .padding(20)
      .backgroundColor(this.getColorScheme().DIALOG.backgroundColor)
      .borderRadius(12)
      .shadow({ radius: 20, color: '#00000040' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#00000040')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.showCreateDialog = false;
    })
  }

  @Builder
  buildRenameDialog() {
    Column() {
      Column() {
        Text('é‡å‘½åè´¦æœ¬')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getColorScheme().DIALOG.titleColor)
          .margin({ bottom: 20 })

        // è´¦æœ¬åç§°
        Text('æ–°åç§°')
          .fontSize(14)
          .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        TextInput({ placeholder: 'è¯·è¾“å…¥æ–°åç§°', text: this.renameBookName })
          .width('100%')
          .height(44)
          .backgroundColor(this.getColorScheme().LIST_ITEM.backgroundColor)
          .onChange((value: string) => {
            this.renameBookName = value;
          })
          .margin({ bottom: 20 })

        // æŒ‰é’®
        Row() {
          Button('å–æ¶ˆ')
            .width('48%')
            .height(44)
            .backgroundColor(this.getColorScheme().LIST_ITEM.backgroundColor)
            .fontColor(this.getColorScheme().LIST_ITEM.categoryColor)
            .onClick(() => {
              this.showRenameDialog = false;
              this.renameBook = null;
              this.renameBookName = '';
            })

          Button('ç¡®å®š')
            .width('48%')
            .height(44)
            .backgroundColor(this.getColorScheme().TYPE_SELECTOR.activeBackground)
            .fontColor('#FFFFFF')
            .onClick(() => {
              this.renameBookConfirm();
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('85%')
      .padding(20)
      .backgroundColor(this.getColorScheme().DIALOG.backgroundColor)
      .borderRadius(12)
      .shadow({ radius: 20, color: '#00000040' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#00000040')
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.showRenameDialog = false;
    })
  }

  formatDate(isoString: string): string {
    const date = new Date(isoString);
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  }
}
