// è´¦æœ¬ç®¡ç†å·¥å…·ç±»
import preferences from '@ohos.data.preferences';
import { AccountBook } from '../models/AccountBook';
import common from '@ohos.app.ability.common';

export class AccountBookUtil {
  private static context: common.UIAbilityContext;
  private static preferences: preferences.Preferences | null = null;
  private static readonly BOOKS_KEY = 'account_books';
  private static readonly CURRENT_BOOK_KEY = 'current_book_id';
  private static currentBookId: string = '';

  // åˆå§‹åŒ–
  static async init(context: common.UIAbilityContext) {
    AccountBookUtil.context = context;
    try {
      AccountBookUtil.preferences = await preferences.getPreferences(context, 'account_books_store');
      
      // è·å–å½“å‰è´¦æœ¬ID
      AccountBookUtil.currentBookId = await AccountBookUtil.preferences.get(AccountBookUtil.CURRENT_BOOK_KEY, '') as string;
      
      // å¦‚æœæ²¡æœ‰è´¦æœ¬ï¼Œåˆ›å»ºé»˜è®¤è´¦æœ¬
      const books = await AccountBookUtil.getAllBooks();
      if (books.length === 0) {
        await AccountBookUtil.createDefaultBook();
      }
      
      // å¦‚æœæ²¡æœ‰å½“å‰è´¦æœ¬ï¼Œè®¾ç½®ç¬¬ä¸€ä¸ªä¸ºå½“å‰è´¦æœ¬
      if (!AccountBookUtil.currentBookId) {
        const allBooks = await AccountBookUtil.getAllBooks();
        if (allBooks.length > 0) {
          await AccountBookUtil.setCurrentBook(allBooks[0].id);
        }
      }
    } catch (error) {
      console.error('åˆå§‹åŒ–è´¦æœ¬ç®¡ç†å¤±è´¥:', error);
    }
  }

  // åˆ›å»ºé»˜è®¤è´¦æœ¬
  private static async createDefaultBook(): Promise<void> {
    const defaultBook: AccountBook = {
      id: AccountBookUtil.generateId(),
      name: 'é»˜è®¤è´¦æœ¬',
      icon: 'ğŸ“’',
      createTime: new Date().toISOString(),
      isDefault: true
    };
    
    await AccountBookUtil.saveBook(defaultBook);
    await AccountBookUtil.setCurrentBook(defaultBook.id);
  }

  // ç”Ÿæˆå”¯ä¸€ID
  private static generateId(): string {
    return `book_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }

  // è·å–æ‰€æœ‰è´¦æœ¬
  static async getAllBooks(): Promise<AccountBook[]> {
    try {
      if (!AccountBookUtil.preferences) return [];
      
      const booksJson = await AccountBookUtil.preferences.get(AccountBookUtil.BOOKS_KEY, '[]') as string;
      return JSON.parse(booksJson) as AccountBook[];
    } catch (error) {
      console.error('è·å–è´¦æœ¬åˆ—è¡¨å¤±è´¥:', error);
      return [];
    }
  }

  // ä¿å­˜è´¦æœ¬
  static async saveBook(book: AccountBook): Promise<void> {
    try {
      if (!AccountBookUtil.preferences) return;
      
      const books = await AccountBookUtil.getAllBooks();
      const index = books.findIndex(b => b.id === book.id);
      
      if (index >= 0) {
        books[index] = book;
      } else {
        books.push(book);
      }
      
      await AccountBookUtil.preferences.put(AccountBookUtil.BOOKS_KEY, JSON.stringify(books));
      await AccountBookUtil.preferences.flush();
    } catch (error) {
      console.error('ä¿å­˜è´¦æœ¬å¤±è´¥:', error);
    }
  }

  // åˆ é™¤è´¦æœ¬
  static async deleteBook(bookId: string): Promise<boolean> {
    try {
      if (!AccountBookUtil.preferences) return false;
      
      const books = await AccountBookUtil.getAllBooks();
      const book = books.find(b => b.id === bookId);
      
      // ä¸èƒ½åˆ é™¤é»˜è®¤è´¦æœ¬
      if (book?.isDefault) {
        return false;
      }
      
      // ä¸èƒ½åˆ é™¤å½“å‰è´¦æœ¬
      if (bookId === AccountBookUtil.currentBookId) {
        return false;
      }
      
      const newBooks = books.filter(b => b.id !== bookId);
      await AccountBookUtil.preferences.put(AccountBookUtil.BOOKS_KEY, JSON.stringify(newBooks));
      await AccountBookUtil.preferences.flush();
      
      return true;
    } catch (error) {
      console.error('åˆ é™¤è´¦æœ¬å¤±è´¥:', error);
      return false;
    }
  }

  // è·å–å½“å‰è´¦æœ¬ID
  static getCurrentBookId(): string {
    return AccountBookUtil.currentBookId;
  }

  // è·å–å½“å‰è´¦æœ¬
  static async getCurrentBook(): Promise<AccountBook | null> {
    const books = await AccountBookUtil.getAllBooks();
    return books.find(b => b.id === AccountBookUtil.currentBookId) || null;
  }

  // è®¾ç½®å½“å‰è´¦æœ¬
  static async setCurrentBook(bookId: string): Promise<void> {
    try {
      if (!AccountBookUtil.preferences) return;
      
      AccountBookUtil.currentBookId = bookId;
      await AccountBookUtil.preferences.put(AccountBookUtil.CURRENT_BOOK_KEY, bookId);
      await AccountBookUtil.preferences.flush();
    } catch (error) {
      console.error('è®¾ç½®å½“å‰è´¦æœ¬å¤±è´¥:', error);
    }
  }

  // åˆ›å»ºæ–°è´¦æœ¬
  static async createBook(name: string, icon: string = 'ğŸ“’'): Promise<AccountBook> {
    const newBook: AccountBook = {
      id: AccountBookUtil.generateId(),
      name: name,
      icon: icon,
      createTime: new Date().toISOString(),
      isDefault: false
    };
    
    await AccountBookUtil.saveBook(newBook);
    return newBook;
  }
}
