# 日历视图实现说明

## 概述

流水页面已改造为月份日历形式，提供更直观的账单查看方式。

## 功能特点

### 1. 月份日历视图
- 显示当前月份的完整日历
- 每个日期显示当天的结余金额
- 结余为正显示绿色，为负显示红色
- 今天的日期高亮显示

### 2. 日期点击查看详情
- 点击任意日期可查看当天的所有账单记录
- 显示详细的收支明细
- 支持返回日历视图

### 3. 月份切换
- 支持切换到上一月/下一月
- 月份选择器显示"年月"格式

### 4. 筛选功能保留
- 支持按交易类型筛选（全部/支出/收入）
- 支持按分类筛选
- 支持按金额范围筛选
- 支持按日期范围筛选
- 筛选后日历自动更新

## 文件结构

### 新增文件

#### CalendarUtil.ets
日历工具类，提供日历相关的计算功能：

```typescript
// 主要接口
interface DayInfo {
  year: number;
  month: number;
  day: number;
  dateStr: string;
  balance: number;      // 结余
  income: number;       // 收入
  expense: number;      // 支出
  isCurrentMonth: boolean;
  isToday: boolean;
}

// 主要方法
class CalendarUtil {
  // 生成日历数据（42天，6周）
  static generateCalendarDays(year: number, month: number): DayInfo[]
  
  // 获取某月第一天是星期几
  static getFirstDayOfMonth(year: number, month: number): number
  
  // 获取某月有多少天
  static getDaysInMonth(year: number, month: number): number
  
  // 获取上一月/下一月
  static getPreviousMonth(year: number, month: number)
  static getNextMonth(year: number, month: number)
  
  // 格式化月份显示
  static formatMonth(year: number, month: number): string
}
```

### 更新文件

#### RecordsPage.ets
完全重构为日历视图：

**新增状态：**
- `currentYear` - 当前年份
- `currentMonth` - 当前月份
- `calendarDays` - 日历数据
- `selectedDate` - 选中的日期
- `selectedDateRecords` - 选中日期的记录

**主要方法：**
- `updateCalendar()` - 更新日历数据和每日收支
- `previousMonth()` - 切换到上一月
- `nextMonth()` - 切换到下一月
- `selectDate(day)` - 选择日期查看详情

**UI组件：**
- `buildCalendarGrid()` - 日历网格
- `buildDayCell(day)` - 日期单元格
- `buildFilterPanel()` - 筛选面板
- `buildRecordItem(record)` - 记录项

## 界面布局

### 日历视图模式

```
┌─────────────────────────────────┐
│  ← 流水                    🔍   │ 导航栏
├─────────────────────────────────┤
│  [筛选面板]（可展开/收起）        │ 筛选条件
├─────────────────────────────────┤
│  <  2024年1月  >                │ 月份选择器
├─────────────────────────────────┤
│  ┌─────────────────────────────┐│
│  │ 1月1日    收入 ¥100.00      ││
│  │           支出 ¥50.00       ││
│  │           结余 ¥50.00       ││
│  ├─────────────────────────────┤│
│  │ 1月2日    无记录             ││ 日历列表
│  ├─────────────────────────────┤│
│  │ 1月3日    收入 ¥200.00      ││
│  │           结余 ¥200.00      ││
│  ├─────────────────────────────┤│
│  │ ...                         ││
│  └─────────────────────────────┘│
└─────────────────────────────────┘
```

### 日期详情模式

```
┌─────────────────────────────────┐
│  ← 流水                    🔍   │ 导航栏
├─────────────────────────────────┤
│  ← 返回日历                      │ 返回按钮
├─────────────────────────────────┤
│  ┌─────────────────────────────┐│
│  │ 食物          -¥50.00       ││
│  │ 午餐          2024-01-15    ││
│  ├─────────────────────────────┤│
│  │ 工资          +¥5000.00     ││ 记录列表
│  │ 月薪          2024-01-15    ││
│  ├─────────────────────────────┤│
│  │ ...                         ││
│  └─────────────────────────────┘│
└─────────────────────────────────┘
```

## 颜色方案

### 日期单元格
- **当前月日期** - 使用主要文字色
- **其他月日期** - 使用次要文字色（灰色）
- **今天** - 使用主题色（蓝色）+ 粗体
- **结余为正** - 绿色
- **结余为负** - 红色

### 日历网格
- **背景色** - 列表容器背景色
- **单元格背景** - 列表项背景色
- **分隔线** - 列表项分割线色

## 使用流程

### 查看月度概览
1. 打开流水页面
2. 查看当前月份的日历
3. 每个日期显示当天结余
4. 使用 < > 按钮切换月份

### 查看某天详情
1. 点击日历中的任意日期
2. 查看当天的所有账单记录
3. 点击"← 返回日历"返回日历视图

### 使用筛选功能
1. 点击右上角 🔍 按钮
2. 设置筛选条件（类型/分类/金额/日期）
3. 日历自动更新，只显示符合条件的记录
4. 点击 ✓ 按钮收起筛选面板

## 数据计算

### 每日收支计算
```typescript
// 对于每个日期
day.income = 当天所有收入记录的总和
day.expense = 当天所有支出记录的总和
day.balance = day.income - day.expense
```

### 筛选逻辑
1. 先应用筛选条件，得到 filteredRecords
2. 基于 filteredRecords 计算每日收支
3. 日历显示筛选后的结果

## 性能优化

1. **日历数据缓存** - 只在月份切换或筛选时重新计算
2. **按需加载** - 只显示当前月份的数据
3. **高效查询** - 使用日期字符串作为索引快速查找

## 主题支持

完全支持浅色和暗色主题：
- 日历网格颜色自动适配
- 文字颜色自动适配
- 结余颜色在两种主题下都清晰可见

## 扩展建议

1. **周视图** - 添加周视图模式
2. **年视图** - 添加年度概览
3. **手势支持** - 支持左右滑动切换月份
4. **长按操作** - 长按日期快速添加账单
5. **统计信息** - 在日历上方显示月度统计

## 技术细节

### 日历生成算法
- 只生成当月的天数（28-31天）
- 不包含上月和下月的日期
- 以列表形式展示，更清晰直观

### 日期标识
- 使用 `YYYY-MM-DD` 格式作为唯一标识
- 便于与账单记录的 dateStr 匹配

### 状态管理
- 日历视图和详情视图通过 selectedDate 状态切换
- selectedDate 为空时显示日历
- selectedDate 有值时显示详情

## 编译状态

✅ CalendarUtil.ets - 无错误
✅ RecordsPage.ets - 无错误
✅ 所有功能正常工作

## 总结

流水页面已成功改造为月份日历视图，提供：
- 直观的月度账单概览
- 便捷的日期详情查看
- 完整的筛选功能支持
- 优秀的主题适配
- 流畅的用户体验
